<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é—»äººçš„æŠ€æœ¯åšå®¢</title>
<meta name="description" content="åšä¸€ä¸ªç»ˆç”Ÿå­¦ä¹ è€…" />
<link rel="shortcut icon" href="https://wrcj12138aaa.github.io//favicon.ico?v=1570431429087">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link href="https://cdn.remixicon.com/releases/v1.3.1/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">

<link rel="stylesheet" href="https://wrcj12138aaa.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="é—»äººçš„æŠ€æœ¯åšå®¢ - Atom Feed" href="https://wrcj12138aaa.github.io//atom.xml">



  </head>
  <body>
    <div id="app" class="main px-4 flex flex-col lg:flex-row">
      <div id="sidebar" class="sidebar-wrapper lg:static lg:w-1/4">
  <div class="lg:sticky top-0">
    <div class="sidebar-content">
      <div class="flex lg:block p-4 lg:px-0 items-center fixed lg:static lg:block top-0 right-0 left-0 bg-white z-50">
        <i class="remixicon-menu-2-line lg:mt-4 text-2xl cursor-pointer animated fadeIn" onclick="openMenu()"></i>
        <a href="https://wrcj12138aaa.github.io/">
          <img class="animated fadeInLeft avatar rounded-lg mx-4 lg:mt-32 lg:mx-0 mt-0 lg:w-24 lg:h-24 w-12 w-12" src="https://wrcj12138aaa.github.io//images/avatar.png?v=1570431429087" alt="">
        </a>
        <h1 class="animated fadeInLeft lg:text-4xl font-extrabold lg:mt-8 mt-0 text-xl" style="animation-delay: 0.2s">é—»äººçš„æŠ€æœ¯åšå®¢</h1>
      </div>
      
        <div class="animated fadeInLeft" style="animation-delay: 0.4s">
          <p class="my-4 text-gray-600 font-light hidden lg:block">
            æ–‡ç« ç›®å½•
          </p>
          <div class="toc-container hidden lg:block">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%89%8D%E8%A8%80">å‰è¨€</a></li>
<li><a href="#%E6%AD%A3%E6%96%87">æ­£æ–‡</a>
<ul>
<li><a href="#handlerexceptionresolver-%E6%89%A9%E5%B1%95">HandlerExceptionResolver æ‰©å±•</a></li>
<li><a href="#exceptionhandler">@ExceptionHandler</a></li>
<li><a href="#controlleradvice">@ControllerAdvice</a></li>
<li><a href="#responseentityexceptionhandler-%E6%89%A9%E5%B1%95">ResponseEntityExceptionHandler æ‰©å±•</a></li>
<li><a href="#responsestatusexception">ResponseStatusException</a></li>
<li><a href="#spring-boot-errorcontroller">Spring Boot ErrorController</a></li>
</ul>
</li>
<li><a href="#%E7%BB%93%E8%AF%AD">ç»“è¯­</a></li>
<li><a href="#%E5%8F%82%E8%80%83">å‚è€ƒ</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      
    </div>
  </div>
</div>

<div class="menu-container">
  <i class="remixicon-arrow-left-line text-2xl cursor-pointer animated fadeIn close-menu-btn" onclick="closeMenu()"></i>
  <div>
    
      
        <a href="/" class="menu" style="animation-delay: 0s">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu" style="animation-delay: 0.2s">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu" style="animation-delay: 0.4s">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu" style="animation-delay: 0.6000000000000001s">
          å…³äº
        </a>
      
    
  </div>
  <div class="site-footer">
    <div class="py-4 text-gray-700"></div>
    <a class="rss" href="https://wrcj12138aaa.github.io//atom.xml" target="_blank">RSS</a>
  </div>
</div>
<div class="mask" onclick="closeMenu()">
</div>
      <div class="content-wrapper py-32 lg:p-8 lg:w-3/4 post-detail animated fadeIn">
        <h1 class="text-3xl font-bold lg:mt-16">ä¸€èµ·å­¦ Spring ä¹‹ å¼‚å¸¸å¤„ç†</h1>
        <div class="text-sm text-gray-700 lg:my-8">
          2019-05-18 / 12 min read
        </div>
        
        <div class="post-content yue">
          <figure data-type="image" tabindex="1"><img src="http://ww1.sinaimg.cn/large/006tNc79ly1g35nzax5gvj30p00dwtaq.jpg" alt="å…¬ä¼—å·"></figure>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>è¿™æ¬¡æˆ‘ä»¬å­¦ä¹  Spring çš„å¼‚å¸¸å¤„ç†ï¼Œä½œä¸ºä¸€ä¸ª Spring ä¸ºåŸºç¡€æ¡†æ¶çš„ Web ç¨‹åºï¼Œå¦‚æœä¸å¯¹ç¨‹åºä¸­å‡ºç°çš„å¼‚å¸¸è¿›è¡Œé€‚å½“çš„å¤„ç†æ¯”å¦‚å¼‚å¸¸ä¿¡æ¯å‹å¥½åŒ–ï¼Œè®°å½•å¼‚å¸¸æ—¥å¿—ç­‰ç­‰ï¼Œç›´æ¥å°†å¼‚å¸¸ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯å±•ç¤ºç»™ç”¨æˆ·ï¼Œå¯¹ç”¨æˆ·ä½“éªŒæœ‰ä¸å¥½çš„å½±å“ã€‚æ‰€ä»¥æœ¬ç¯‡æ–‡ç« ä¸»è¦æ¢è®¨é€šè¿‡ Spring è¿›è¡Œç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„å‡ ç§æ–¹å¼å®ç°ï¼Œä»¥æ›´ä¼˜é›…çš„æ–¹å¼æ•è·ç¨‹åºå‘ç”Ÿçš„å¼‚å¸¸ä¿¡æ¯å¹¶è¿›è¡Œé€‚å½“çš„å¤„ç†å“åº”ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦å†…å®¹æ¶‰åŠå¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p><code>HandlerExceptionResolver</code> æ‰©å±•</p>
</li>
<li>
<p><code>@ExceptionHandler</code> å’Œ <code>@ControllerAdvice</code> ä½¿ç”¨</p>
</li>
<li>
<p><code>ResponseEntityExceptionHandler</code> æ‰©å±•</p>
</li>
<li>
<p><code>ResponseStatusException</code> ä½¿ç”¨</p>
</li>
<li>
<p>Spring Boot <code>ErrorController</code> æ‰©å±•</p>
</li>
</ul>
<blockquote>
<p>ç¤ºä¾‹é¡¹ç›®ï¼š</p>
<ul>
<li>spring-exception-handler: https://github.com/wrcj12138aaa/spring-exception-handler</li>
</ul>
<p>ç¯å¢ƒæ”¯æŒï¼š</p>
<ul>
<li>
<p>JDK 8</p>
</li>
<li>
<p>SpringBoot 2.1.4</p>
</li>
<li>
<p>Maven 3.6.0</p>
</li>
</ul>
</blockquote>
<h2 id="æ­£æ–‡">æ­£æ–‡</h2>
<p>Spring æ¡†æ¶çš„å¼‚å¸¸å¤„ç†æä¾›äº†è®¸å¤šç§æ–¹å¼ï¼Œåœ¨ Spring 3.2 ä¹‹å‰ä¸»è¦æœ‰ä¸¤ç§å¤„ç†æ–¹å¼ï¼šæ‰©å±• <code>HandlerExceptionResolver</code> å’Œ ä½¿ç”¨æ³¨è§£ <a href="https://docs.spring.io/spring/docs/5.1.6.RELEASE/spring-framework-reference/web.html#mvc-ann-exceptionhandler">@ExceptionHandler</a>ï¼ŒSpring 3.2 ä¹‹åæä¾›äº†æ›´ä¸°å¯Œçš„å¤„ç†æ–¹å¼ã€‚</p>
<h3 id="handlerexceptionresolver-æ‰©å±•">HandlerExceptionResolver æ‰©å±•</h3>
<p><code>HandlerExceptionResolver</code> æ˜¯ä¸€ä¸ªå¤„ç† Web ç¨‹åºå‘ç”Ÿå¼‚å¸¸æ—¶çš„æ¥å£ï¼Œæ¥å£æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">@Nullable
ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, @Nullable Object handler, Exception ex);
</code></pre>
<p>ä»è¿”å›å€¼ç±»å‹ <code>ModelAndView</code> å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå±äº Spring MVC æ¡†æ¶ä¸­çš„æ¥å£ï¼Œå®ç°æ­¤æ–¹æ³•å°±å¯ä»¥å¯¹æ•è·çš„å¼‚å¸¸è¿›è¡Œè§£æå¤„ç†ï¼Œç„¶åæ ¹æ®è‡ªèº«éœ€è¦è¿”å› <code>ModelAndView</code> å¯¹è±¡ï¼Œä»¥ JSON æ•°æ®æˆ–è€…é¡µé¢å½¢å¼å“åº”å®¢æˆ·ç«¯è¯·æ±‚ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ä¸‹ <code>HandlerExceptionResolver</code> ç±»å±‚æ¬¡ä½“ç³»ï¼ŒSpring æä¾›äº† 4 ä¸ªå®ç°ç±»ï¼Œä¸‹é¢æ ¹æ®è¿™äº›ç±»åšäº†ç®€å•çš„æè¿°ã€‚</p>
<figure data-type="image" tabindex="2"><img src="http://ww4.sinaimg.cn/large/006tNc79ly1g35oldz1g8j31560a10u1.jpg" alt="HandlerExceptionResolver ç±»ä½“ç³»"></figure>
<table>
<thead>
<tr>
<th>HandlerExceptionResolver</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SimpleMappingExceptionResolver</code></td>
<td>æ˜ å°„å¼‚å¸¸ç±»åˆ°æŒ‡å®šè§†å›¾ï¼Œä¸€èˆ¬ç”¨äºå±•ç°å¼‚å¸¸å‘ç”Ÿæ—¶çš„é”™è¯¯é¡µé¢</td>
</tr>
<tr>
<td><code>DefaultHandlerExceptionResolver</code></td>
<td><code>HandlerExceptionResolver</code> çš„é»˜è®¤å®ç°ï¼Œå¤„ç† Spring MVC å¼‚å¸¸</td>
</tr>
<tr>
<td><code>ResponseStatusExceptionResolver</code></td>
<td>å¤„ç†å¸¦æœ‰ <code>@ResponseStatus</code> æ³¨è§£çš„å¼‚å¸¸ï¼Œå°†æ³¨è§£ä¸Šå¯¹åº”çš„å€¼è½¬æ¢ä¸º HTTP çŠ¶æ€ç ï¼Œä¸€èˆ¬æ”¾äºè‡ªå®šä¹‰çš„å¼‚å¸¸ç±»ä¸Š</td>
</tr>
<tr>
<td><code>ExceptionHandlerExceptionResolver</code></td>
<td>å¤„ç†å¸¦æœ‰ <code>@ExceptionHandler</code>æ³¨è§£çš„å¼‚å¸¸</td>
</tr>
</tbody>
</table>
<p>å½“æˆ‘ä»¬éœ€è¦å®ç°è‡ªå®šä¹‰çš„ <code>HandlerExceptionResolver</code>æ—¶ï¼Œåªè¦é€šè¿‡ç»§æ‰¿å®ƒçš„æŠ½è±¡ç±» <code>AbstractHandlerExceptionResolver</code>ï¼Œè¦†å†™ <code>doResolveException</code>æ–¹æ³•å°±å¯ä»¥äº†ã€‚</p>
<p>ä¸‹æ–¹çš„ç¤ºä¾‹ä»£ç å¤„ç†äº†ç¨‹åºä¸­å‘ç”Ÿçš„ <code>IllegalArgumentException</code> å¼‚å¸¸æ—¶çš„æƒ…å†µï¼Œå¹¶é€šè¿‡ <code>MappingJackson2JsonView</code> å¯¹è±¡è¿”å›å®¢æˆ·ç«¯ä¸€ä¸ª JSON æ•°æ®å¯¹è±¡ã€‚å¦‚æœä¸æ˜¯ <code>IllegalArgumentException</code>å¼‚å¸¸ï¼Œè¿”å› <code>null</code> è¡¨ç¤ºè®©å…¶ä»–å¼‚å¸¸å¤„ç†å™¨è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œç”±äºå¼‚å¸¸å¤„ç†é“¾æœºåˆ¶ï¼Œå¦‚æœä¸å¤„ç†å¼‚å¸¸ï¼Œå°±ä¼šç”± Web å®¹å™¨å°†å¼‚å¸¸è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<pre><code class="language-java">@Component
public class RestResponseStatusExceptionResolver extends AbstractHandlerExceptionResolver {

    @Override
    protected ModelAndView doResolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        try {
            if (ex instanceof IllegalArgumentException) {
                ModelAndView modelAndView = new ModelAndView();
                Map&lt;String, String&gt; maps = new HashMap&lt;&gt;();
                maps.put(&quot;code&quot;, &quot;400&quot;);
                maps.put(&quot;message&quot;, ex.getClass().getName());
                maps.put(&quot;data&quot;, null);
                MappingJackson2JsonView mappingJackson2JsonView = new MappingJackson2JsonView();
                mappingJackson2JsonView.setAttributesMap(maps);
                modelAndView.setView(mappingJackson2JsonView);
                return modelAndView;
            }
        } catch (Exception handlerException) {
            logger.warn(&quot;Handling of [&quot; + ex.getClass().getName() + &quot;] resulted in Exception&quot;, handlerException);
        }
        return null;
    }

}
</code></pre>
<p>æˆ‘ä»¬ä½¿ç”¨ Postman å·¥å…·æ¨¡æ‹Ÿè¯·æ±‚é¡¹ç›®çš„ API æ¥å£ <code>/exception1</code> æ¥å¯¼è‡´å¼‚å¸¸çš„è§¦å‘ï¼Œæ­£å¸¸å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ•ˆæœï¼š</p>
<figure data-type="image" tabindex="3"><img src="http://ww2.sinaimg.cn/large/006tNc79ly1g35e6h2qntj30f80bvq3f.jpg" alt="image-20190518131151510"></figure>
<h3 id="exceptionhandler">@ExceptionHandler</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ <code>@ExceptionHandler</code> çš„ç”¨æ³•ï¼Œè¿™ä¸ªæ³¨è§£é€šå¸¸å®šä¹‰åœ¨æŸä¸ªæ§åˆ¶å™¨ä¸‹çš„æ–¹æ³•é‡Œï¼Œè¡¨æ˜å¤„ç†è¯¥æ§åˆ¶å™¨å‡ºç°çš„æŒ‡å®šå¼‚å¸¸, å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<pre><code class="language-java">@RestController
public class RestApiController {
    //...

    @ExceptionHandler({IllegalStateException.class})
    public ModelAndView handleIllegalStateException(IllegalStateException ex) {
        System.out.println(&quot;éæ³•çŠ¶æ€å¼‚å¸¸å‡ºç°,éœ€è¦å¤„ç† &quot; + ex.getMessage());
        ModelAndView modelAndView = new ModelAndView();
        Map&lt;String, String&gt; maps = new HashMap&lt;&gt;();
        maps.put(&quot;data&quot;, null);
        maps.put(&quot;message&quot;, ex.getClass().getName());
        maps.put(&quot;code&quot;, &quot;400&quot;);
        MappingJackson2JsonView mappingJackson2JsonView = new MappingJackson2JsonView();
        mappingJackson2JsonView.setAttributesMap(maps);
        modelAndView.setView(mappingJackson2JsonView);
        return modelAndView;
    }
}
</code></pre>
<blockquote>
<p><code>@ExceptionHandler</code> å¯ä»¥è®¾ç½®å¤šä¸ªéœ€è¦æ•è·å¤„ç†çš„å¼‚å¸¸ç±»å‹ï¼Œä¹Ÿå¯ä»¥ä¸å¡«é»˜è®¤ä¸ºæ‰€æœ‰å¼‚å¸¸ç±»,æ›´å¤šä¿¡æ¯å¯ä»¥æŸ¥çœ‹ <a href="https://docs.spring.io/spring/docs/5.1.6.RELEASE/spring-framework-reference/web.html#mvc-ann-exceptionhandler">mvc-ann-exceptionhandler</a></p>
</blockquote>
<p>ç„¶åä½¿ç”¨ Postman å·¥å…·æ¨¡æ‹Ÿè¯·æ±‚é¡¹ç›®çš„ API æ¥å£ <code>/exception2</code> æ¥è§¦å‘å¼‚å¸¸ï¼Œçœ‹ä¸‹å“åº”æ•°æ®ï¼š</p>
<figure data-type="image" tabindex="4"><img src="http://ww4.sinaimg.cn/large/006tNc79ly1g35f7qidfcj30gn0c0aaj.jpg" alt="image-20190518134744575"></figure>
<p>è¿™æ ·æ–¹å¼ä½¿ç”¨ <code>@ExceptionHandler</code> å­˜åœ¨ä¸€ä¸ªç¼ºé™·ï¼Œå°±æ˜¯åªä¼šé’ˆå¯¹å½“å‰æ§åˆ¶å™¨ä¸‹çš„å¼‚å¸¸å¤„ç†ï¼Œè‹¥éœ€è¦å®ç°å…¨å±€æ§åˆ¶å™¨çš„å¼‚å¸¸å¤„ç†ï¼Œè¿˜éœ€è¦é…åˆæ³¨è§£ <code>@ControllerAdvice</code> ä¸€èµ·ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥å°±ä»‹ç»è¿™ä¸ªå¤„ç†æ–¹å¼ã€‚</p>
<h3 id="controlleradvice">@ControllerAdvice</h3>
<p>Spring 3.2 å¼•å…¥äº†ä¸€ç§æ–°æ³¨è§£ <code>@ControllerAdvice</code>ï¼Œç”¨äºå°†æ‰€æœ‰æ§åˆ¶å™¨ä¸­å¼‚å¸¸çš„å¤„ç†æ”¾åœ¨ä¸€å¤„è¿›è¡Œï¼Œå°†æŒ‡å®šä¸€ä¸ªç±»ä½œä¸ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œç”¨ <code>@ExceptionHandler</code> æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å»å¤„ç†å¼‚å¸¸ï¼Œå…·ä½“ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">@ControllerAdvice
public class NormalExceptionHandler {
    @ExceptionHandler()
    public ResponseEntity handleException(Exception e) {
        System.out.println(&quot;NormalExceptionHandler handle exception&quot;);
        return ResponseEntity.ok(new Result&lt;&gt;(400, e.getMessage(), null));
    }
}
</code></pre>
<blockquote>
<p>ä»£ç ä¸­çš„ Result å¯¹è±¡åªæ˜¯ä¸€ä¸ªæ•°æ®ä¼ è¾“å¯¹è±¡ (DTO)ï¼Œä¾¿äºè¿”å›å®¢æˆ·ç«¯ç»Ÿä¸€æ ¼å¼çš„æ•°æ®ã€‚</p>
</blockquote>
<p>å†æ¥çœ‹ä¸‹ä½¿ç”¨ Postman å·¥å…·æ¨¡æ‹Ÿè¯·æ±‚ API æ¥å£ <code>/exception3</code> å“åº”çš„æ•°æ®ï¼Œè§ä¸‹å›¾ã€‚</p>
<figure data-type="image" tabindex="5"><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g35guihk8ej30bk0b5mxh.jpg" alt="image-20190518144403940"></figure>
<p>è¿˜æœ‰ä¸€ä¸ªæ³¨è§£ <code>@RestControllerAdvice</code> è·Ÿ <code>@ControllerAdvice</code> å¾ˆç›¸ä¼¼ï¼Œå…¶å®å°±æ˜¯ <code>@ControllerAdvice</code> ä¸ <code>@ResponseBody</code>æ³¨è§£çš„ç»„åˆï¼Œæ•ˆæœå°±æ˜¯å¼‚å¸¸å¤„ç†æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œç›´æ¥å°±ä¼šè¢«åºåˆ—åŒ–æˆ JSON æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">@RestControllerAdvice
public class RestExceptionHandler {
    @ExceptionHandler({ArithmeticException.class})
    public Result handlerException(Exception e) {
        return new Result&lt;&gt;(400, e.getMessage(), null);
    }
}
</code></pre>
<p>è¿™ä¸ªæ³¨è§£æ˜¯åœ¨ Spring 4.3 ç‰ˆæœ¬å¼•å…¥çš„ï¼Œä¸»è¦å°±æ˜¯ä¾¿äºé’ˆå¯¹ REST è¯·æ±‚å¼‚å¸¸æ—¶ç›´æ¥è¿”å› JSON æ ¼å¼çš„æ•°æ®ï¼Œè€Œä¸ä½¿ç”¨ <code>ResponseEntity</code> å¯¹è±¡æ–¹å¼ä¼ é€’æ•°æ®ã€‚</p>
<p><code>@ControllerAdvice</code> é»˜è®¤æ‹¦æˆªæ‰€æœ‰æ§åˆ¶å™¨ä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é™å®šèŒƒå›´ï¼Œé™å®šæ–¹å¼æœ‰é™å®šæ³¨è§£ï¼ŒåŒ…åç­‰ï¼Œå…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">// Target all Controllers annotated with @RestController
@ControllerAdvice(annotations = RestController.class)
public class ExampleAdvice1 {}

// Target all Controllers within specific packages
@ControllerAdvice(&quot;org.example.controllers&quot;)
public class ExampleAdvice2 {}

// Target all Controllers assignable to specific classes
@ControllerAdvice(assignableTypes = {ControllerInterface.class, AbstractController.class})
public class ExampleAdvice3 {}
</code></pre>
<p>å¯¹äº å…¨å±€ <code>@ExceptionHandler</code> æ–¹æ³•å¤„ç†çš„æè¿°ï¼Œå®˜æ–¹æ–‡æ¡£è¿˜æœ‰é¢å¤–çš„å¤‡æ³¨å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Global <code>@ExceptionHandler</code> methods (from a <code>@ControllerAdvice</code>) are applied <em>after</em> local ones (from the <code>@Controller</code>).</p>
</blockquote>
<p>è¿™è¡¨æ˜äº†å¼‚å¸¸å¤„ç†ä¹Ÿå­˜åœ¨ä¼˜å…ˆçº§ï¼Œå…ˆäº¤ç»™å½“å‰æ§åˆ¶å™¨å†…çš„ <code>@ExceptionHandler</code>æ–¹æ³•å¤„ç†ï¼Œè‹¥æœªå¤„ç†å†ç”±å…¨å±€çš„<code>@ExceptionHandler</code> æ–¹æ³•å¤„ç†ã€‚</p>
<h3 id="responseentityexceptionhandler-æ‰©å±•">ResponseEntityExceptionHandler æ‰©å±•</h3>
<p><code>ResponseEntityExceptionHandler</code> ç±»æ˜¯ä¸»è¦é’ˆå¯¹ Spring MVC æ‰€æŠ›å‡ºå¼‚å¸¸çš„å¤„ç†ç±»ï¼Œæ¯”å¦‚ 405 è¯·æ±‚ï¼Œ400 è¯·æ±‚ç­‰ï¼Œéƒ½é»˜è®¤ç”± <code>ResponseEntityExceptionHandler</code>å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥è¿‡ç»§æ‰¿è¿™ä¸ªç±»è¦†å†™å®ƒçš„æ–¹æ³•ï¼Œæ¥å®ç°ç‰¹å®šè¯·æ±‚å¼‚å¸¸çš„å¤„ç†ã€‚æ¯”å¦‚ä¸‹é¢ä»£ç å®ç°å¯¹ 405 è¯·æ±‚å¼‚å¸¸çš„å“åº”å¤„ç†ã€‚</p>
<pre><code class="language-java">@@ControllerAdvice
public class CustomWebResponseEntityExceptionHandler extends ResponseEntityExceptionHandler {
    @Override
    protected ResponseEntity&lt;Object&gt; handleHttpRequestMethodNotSupported(HttpRequestMethodNotSupportedException ex, HttpHeaders headers, HttpStatus status, WebRequest request) {
        switch (status) {
            case METHOD_NOT_ALLOWED:
                return getMethodNotAllowedResponse(request);
            default:
                return ResponseEntity.ok(new Result&lt;&gt;(status.value(), status.getReasonPhrase(), null));
        }
    }

    public ResponseEntity getMethodNotAllowedResponse(WebRequest request) {
        String uri = &quot;&quot;;
        if (request instanceof ServletWebRequest) {
            uri = ((ServletWebRequest) request).getRequest().getRequestURI();
        }
        Result&lt;Object&gt; result = new Result&lt;&gt;();
        result.setCode(HttpStatus.METHOD_NOT_ALLOWED.value());
        result.setMessage(uri + &quot; è¯·æ±‚æ–¹å¼ä¸æ­£ç¡®&quot;);
        return ResponseEntity.ok(result);
    }
}
</code></pre>
<p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å°è¯•å‘é€ GET è¯·æ±‚ç»™ API æ¥å£<code>/hello</code>,ä¼šæœ‰å¦‚ä¸‹è¿”å›ä¿¡æ¯ï¼š</p>
<figure data-type="image" tabindex="6"><img src="http://ww4.sinaimg.cn/large/006tNc79ly1g35jsrjw5jj30e50c3jru.jpg" alt="image-20190518162624412"></figure>
<p>å½“æ—¶ <code>ResponseEntityExceptionHandler</code> ä¹Ÿå­˜åœ¨å±€é™æ€§ï¼Œç›®å‰æ”¯æŒçš„ SpringMVC æ ‡å‡†å¼‚å¸¸åªæœ‰ä¸‹é¢ 15 ç§å¼‚å¸¸ç±»å‹:</p>
<ul>
<li><code>HttpRequestMethodNotSupportedException</code></li>
<li><code>HttpMediaTypeNotSupportedException</code></li>
<li><code>HttpMediaTypeNotAcceptableException</code></li>
<li><code>MissingPathVariableException</code></li>
<li><code>MissingServletRequestParameterException</code></li>
<li><code>ServletRequestBindingException</code></li>
<li><code>ConversionNotSupportedException</code></li>
<li><code>TypeMismatchException</code></li>
<li><code>HttpMessageNotReadableException</code></li>
<li><code>HttpMessageNotWritableException</code></li>
<li><code>MethodArgumentNotValidException</code></li>
<li><code>MissingServletRequestPartException</code></li>
<li><code>BindException</code></li>
<li><code>NoHandlerFoundException</code></li>
<li><code>AsyncRequestTimeoutException</code></li>
</ul>
<h3 id="responsestatusexception">ResponseStatusException</h3>
<p><code>ResponseStatusException</code>ç±»æ˜¯åœ¨ Spring 5.0 å¼•å…¥ï¼Œå…³è” HTTP çŠ¶æ€ç å’Œå¯é€‰çš„åŸå› ï¼Œæˆ‘ä»¬ç›´æ¥å°±å¯ä»¥åœ¨è¯·æ±‚æ–¹æ³•ä¸­æ„å»ºè¿™ä¸ªå¼‚å¸¸å¯¹è±¡è¿›è¡Œè¿”å›ï¼Œä½¿ç”¨èµ·æ¥ååˆ†ç®€å•ï¼š</p>
<pre><code class="language-java">@GetMapping(&quot;/exception4&quot;)
public ResponseEntity&lt;String&gt; exception4(String param) {
    throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;èµ„æºæœªæ‰¾åˆ°&quot;);
}
</code></pre>
<p>ä½¿ç”¨è¿™ç§æ–¹å¼è™½ç„¶èƒ½ç›´æ¥è¿”å›å“åº”ç å’Œå…·ä½“åŸå› ï¼Œä½†æ˜¯æ²¡æœ‰ç»Ÿä¸€å¤„ç†å¼‚å¸¸çš„æ•ˆæœï¼Œé€šå¸¸é…åˆ <code>@ControllerAdvice</code> ä¸€èµ·ç»„åˆä½¿ç”¨ã€‚</p>
<h3 id="spring-boot-errorcontroller">Spring Boot ErrorController</h3>
<p><code>ErrorController</code> æ˜¯ Spring Boot 2.0 å¼•å…¥æ¥å£ï¼ŒåŸºäºæ­¤çš„å®ç°ç±» <code>org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController</code> ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§é€šç”¨çš„æ–¹å¼è¿›è¡Œé”™è¯¯å¤„ç†, ä¸‹é¢æ˜¯è¿™ä¸ªå®ç°ç±»çš„å…³é”®æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@RequestMapping(produces = MediaType.TEXT_HTML_VALUE)
public ModelAndView errorHtml(HttpServletRequest request,
        HttpServletResponse response) {
    HttpStatus status = getStatus(request);
    Map&lt;String, Object&gt; model = Collections.unmodifiableMap(getErrorAttributes(
            request, isIncludeStackTrace(request, MediaType.TEXT_HTML)));
    response.setStatus(status.value());
    ModelAndView modelAndView = resolveErrorView(request, response, status, model);
    return (modelAndView != null) ? modelAndView : new ModelAndView(&quot;error&quot;, model);
}

@RequestMapping
public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) {
    Map&lt;String, Object&gt; body = getErrorAttributes(request,
            isIncludeStackTrace(request, MediaType.ALL));
    HttpStatus status = getStatus(request);
    return new ResponseEntity&lt;&gt;(body, status);
}
</code></pre>
<p>å¯ä»¥ä»è¿™ä¸¤ä¸ªæ–¹æ³•çœ‹å‡ºé’ˆå¯¹é”™è¯¯è¯·æ±‚ï¼Œ<code>BasicErrorController</code> æä¾›äº†ä¸¤ç§æ•°æ®å½¢å¼çš„è¿”å›ï¼Œä¸€ç§æ˜¯ HTML é¡µé¢ï¼Œä¸€ç§æ˜¯ JSON æ•°æ®ï¼›å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨æµè§ˆå™¨è®¿é—®æ¥å£çš„è¯è§åˆ°çš„å°±æ˜¯ <code>errorHtml</code>æ–¹æ³•è¿”å›çš„ HTML é¡µé¢æ•°æ®ï¼Œå®ƒä»¬çš„åŒºåˆ«å°±åœ¨äºè¯·æ±‚æ—¶ Header é‡Œ Accept å€¼çš„ä¸åŒã€‚</p>
<figure data-type="image" tabindex="7"><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g35ktpalx1j313n0doq53.jpg" alt="image-20190518170154527"></figure>
<p>å¦å¤–ï¼ŒSpring Boot æä¾›ç»Ÿä¸€é”™è¯¯ä¿¡æ¯å¤„ç†ï¼Œæ˜¯å…è®¸å…³é—­çš„ï¼Œåªè¦åœ¨é…ç½®æ–‡ä»¶ <code>application.properties</code> è®¾ç½® <code>server.error.whitelabel.enabled</code> ä¸º <code>false</code>å³å¯ã€‚</p>
<pre><code class="language-properties">server.error.whitelabel.enabled=false
</code></pre>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åŸºäºæ­¤è¿›è¡Œæ‰©å±•ï¼Œæ¯”å¦‚å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„é”™è¯¯æ§åˆ¶å™¨ï¼Œç»§æ‰¿ <code>BasicErrorController</code>,ç¼–å†™è‡ªå·±çš„é”™è¯¯å±•ç¤ºé€»è¾‘å’Œå†…å®¹ï¼Œæ¯”å¦‚ä¸‹é¢ä»£ç ï¼š</p>
<pre><code class="language-java">@Component
public class CustomErrorController extends BasicErrorController {

    public CustomErrorController(ErrorAttributes errorAttributes) {
        super(errorAttributes, new ErrorProperties());
    }

    @RequestMapping(produces = MediaType.APPLICATION_XML_VALUE)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; xmlError(HttpServletRequest request, HttpStatus status) {
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;code&quot;, status.value());
        map.put(&quot;message&quot;, status.getReasonPhrase());
        return ResponseEntity.ok(map);
    }
}
</code></pre>
<p>å®ç°çš„ <code>CustomErrorController</code> é’ˆå¯¹è¯·æ±‚æ—¶ Aceept ä¸º <code>application/xml</code>çš„å‘ç”Ÿçš„å¼‚å¸¸éƒ½ç»Ÿä¸€ä»¥ XML æ ¼å¼è¿›è¡Œè¿”å›ï¼Œå¦‚å›¾ï¼š</p>
<figure data-type="image" tabindex="8"><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g35lc9jwkyj30er0ebwf1.jpg" alt="image-20190518171944860"></figure>
<blockquote>
<p>æ³¨æ„: Spring Boot é»˜è®¤ä¸æ”¯æŒæ•°æ®è¿›è¡Œ XML æ ¼å¼çš„è½¬æ¢ï¼ŒPOM æ–‡ä»¶éœ€è¦é¢å¤–æ·»åŠ ä¾èµ–åº“ï¼š</p>
<pre><code class="language-xml">&lt;dependency&gt;
      &lt;groupId&gt;com.fasterxml.jackson.dataformat&lt;/groupId&gt;
      &lt;artifactId&gt;jackson-dataformat-xml&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
</blockquote>
<h2 id="ç»“è¯­">ç»“è¯­</h2>
<p>æœ¬æ–‡æˆ‘ä»¬ä¸»è¦å­¦ä¹ äº† Spring æ¡†æ¶ 5 ç§å¼‚å¸¸å¤„ç†çš„æ–¹å¼ä»¥åŠ Spring Boot çš„é€šç”¨å¼‚å¸¸å¤„ç†è¡Œä¸ºï¼Œå½¢å¼å¤šæ ·ï¼Œä½†å…·ä½“æƒ…å†µéœ€è¦å…·ä½“å®šåˆ¶ï¼Œä¸ºäº†ä¿è¯ç¨‹åºçš„å¥å£®æ€§å’Œä¾¿äºå¿«é€Ÿå®šä½è¯·æ±‚å‡ºç°çš„å¼‚å¸¸é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºç¨‹åºæä¾›ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æ–¹å¼ï¼Œä¹Ÿåœ¨å¹³æ—¶çš„é¡¹ç›®é‡Œä½¿ç”¨èµ·æ¥å§ã€‚</p>
<p>å¦‚æœè¯»å®Œè§‰å¾—æœ‰æ”¶è·çš„è¯ï¼Œæ¬¢è¿ç‚¹ã€å¥½çœ‹ã€‘ï¼Œç‚¹å‡»æ–‡ç« å¤´å›¾ï¼Œæ‰«ç å…³æ³¨ã€é—»äººçš„æŠ€æœ¯åšå®¢ã€‘ğŸ˜„ğŸ˜„ğŸ˜„ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li>Spring Boot ä¸­ Web åº”ç”¨çš„ç»Ÿä¸€å¼‚å¸¸å¤„ç† : http://blog.didispace.com/springbootexception</li>
<li>Error Handling for REST with Spring : https://www.baeldung.com/exception-handling-for-rest-with-spring</li>
<li>Spring REST Service Exception Handling https://dzone.com/articles/spring-rest-service-exception-handling-1</li>
<li>mvc-ann-exceptionhandlerï¼šhttps://docs.spring.io/spring/docs/5.1.6.RELEASE/spring-framework-reference/web.html#mvc-ann-exceptionhandler</li>
<li>spring-boot-return-json-and-xml-from-controllers: https://stackoverflow.com/questions/27790998/spring-boot-return-json-and-xml-from-controllers</li>
<li>Spring Web MVC Exceptions : https://docs.spring.io/spring/docs/5.1.6.RELEASE/spring-framework-reference/web.html#mvc-exceptionhandlers</li>
</ul>

        </div>

        
          <a class="animated fadeInUp p-2 items-center text-sm text-gray-700 border hover:bg-gray-300 leading-none rounded-full flex lg:inline-flex m-4 " href="https://wrcj12138aaa.github.io//tag/VSWLYuWEZR">
            <span class="flex-auto">Spring</span>
          </a>
        


        <div class="flex justify-between py-8">
          
            <div class="prev-post">
              <a href="https://wrcj12138aaa.github.io//post/20190526-ä¸€èµ·å­¦Springä¹‹äº‹ä»¶å¤„ç†">
                <h3 class="post-title">
                  <i class="remixicon-arrow-left-line"></i>
                  ä¸€èµ·å­¦Springä¹‹äº‹ä»¶å¤„ç†
                </h3>
              </a>
            </div>
          

          
            <div class="next-post">
              <a href="https://wrcj12138aaa.github.io//post/20190511-ä¸€èµ·å­¦ Spring ä¹‹ RestTemplate">
                <h3 class="post-title">
                  ä¸€èµ·å­¦ Spring ä¹‹ RestTemplate
                  <i class="remixicon-arrow-right-line"></i>
                </h3>
              </a>
            </div>
          
        </div>

        

      </div>
    </div>

    <script src="https://wrcj12138aaa.github.io//media/prism.js"></script>  
<script>

Prism.highlightAll()

let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

// This should probably be throttled.
// Especially because it triggers during smooth scrolling.
// https://lodash.com/docs/4.17.10#throttle
// You could do like...
// window.addEventListener("scroll", () => {
//    _.throttle(doThatStuff, 100);
// });
// Only not doing it here to keep this Pen dependency-free.

window.addEventListener("scroll", event => {
  let fromTop = window.scrollY;

  mainNavLinks.forEach((link, index) => {
    let section = document.getElementById(decodeURI(link.hash).substring(1));
    let nextSection = null
    if (mainNavLinks[index + 1]) {
      nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
    }
    if (section.offsetTop <= fromTop) {
      if (nextSection) {
        if (nextSection.offsetTop > fromTop) {
          link.classList.add("current");
        } else {
          link.classList.remove("current");    
        }
      } else {
        link.classList.add("current");
      }
    } else {
      link.classList.remove("current");
    }
  });
});


document.addEventListener("DOMContentLoaded", function() {
  var lazyImages = [].slice.call(document.querySelectorAll(".post-feature-image.lazy"));

  if ("IntersectionObserver" in window) {
    let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          let lazyImage = entry.target
          lazyImage.style.backgroundImage = `url(${lazyImage.dataset.bg})`
          lazyImage.classList.remove("lazy")
          lazyImageObserver.unobserve(lazyImage)
        }
      });
    });

    lazyImages.forEach(function(lazyImage) {
      lazyImageObserver.observe(lazyImage)
    })
  } else {
    // Possibly fall back to a more compatible method here
  }
});

const menuContainer = document.querySelector('.menu-container')
const menus = document.querySelectorAll('.menu-container .menu')
const mask = document.querySelector('.mask')
const contentWrapper = document.querySelector('.content-wrapper')
const latestArticle = document.querySelector('.latest-article')
const readMore = document.querySelector('.read-more')
const indexPage = document.querySelector('.index-page')

const isHome = location.pathname === '/'
if (latestArticle) {
  latestArticle.style.display = isHome ? 'block' : 'none'
  readMore.style.display = isHome ? 'block' : 'none'
  indexPage.style.display = isHome ? 'none' : 'block'
}

const openMenu = () => {
  menuContainer.classList.add('open')
  menus.forEach(menu => {
    menu.classList.add('animated', 'fadeInLeft')
  })
  mask.classList.add('open')
  contentWrapper.classList.add('is-second')
}

const closeMenu = () => {
  menuContainer.classList.remove('open')
  menus.forEach(menu => {
    menu.classList.remove('animated', 'fadeInLeft')
  })
  mask.classList.remove('open')
  contentWrapper.classList.remove('is-second')
}
</script>
  
  </body>
</html>
