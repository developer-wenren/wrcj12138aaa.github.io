<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta content="yes" name="apple-mobile-web-app-capable" />
  <meta content="black" name="apple-mobile-web-app-status-bar-style" />
  <meta name="referrer" content="never">
  <meta name="keywords" content="">
  <meta name="description" content="">
  <meta name="author" content="kveln">
  <title>ä¸€èµ·å­¦ Spring ä¹‹ å¼‚å¸¸å¤„ç† | é—»äººçš„æŠ€æœ¯åšå®¢</title>
  <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="https://wrcj12138aaa.github.io//media/css/bootstrap.min.css" rel="stylesheet"> -->
  <!--  <link href="https://wrcj12138aaa.github.io//media/css/all.min.css" rel="stylesheet" type="text/css"> -->
  <link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  <link rel="alternate" type="application/rss+xml" title="ä¸€èµ·å­¦ Spring ä¹‹ å¼‚å¸¸å¤„ç† | é—»äººçš„æŠ€æœ¯åšå®¢ Â» Feed" href="https://wrcj12138aaa.github.io//atom.xml">
  <link rel="stylesheet"href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css">
  <link href="https://wrcj12138aaa.github.io//styles/main.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/highlight.min.js"></script>
  <!-- <script src="https://wrcj12138aaa.github.io//media/scripts/jquery.min.js"></script> -->
  <script>hljs.initHighlightingOnLoad();</script>
  

    <meta property="og:description" content="ä¸€èµ·å­¦ Spring ä¹‹ å¼‚å¸¸å¤„ç†"/>
    <meta property="og:url" content="https://wrcj12138aaa.github.io//post/20190518-ä¸€èµ·å­¦ Spring ä¹‹å¼‚å¸¸å¤„ç†"/>
    <meta property="og:locale" content="zh-CN"/>
    <meta property="og:type" content="website"/>
    <meta property="og:site_name" content="é—»äººçš„æŠ€æœ¯åšå®¢"/>
  </head>
  <body>
  	<!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="https://wrcj12138aaa.github.io/">é—»äººçš„æŠ€æœ¯åšå®¢</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          
          <li class="nav-item">
              
              <a class="nav-link" href="/">é¦–é¡µ</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/archives">å½’æ¡£</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/tags">æ ‡ç­¾</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/post/about">å…³äº</a>
              
          </li>
          
        </ul>
      </div>
    </div>
  </nav>
  <!-- Page Header -->
  <header class="masthead" style="background-image: url('https://wrcj12138aaa.github.io//media/images/home-bg.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
          	<span class="tags">
          	 
            <a href="https://wrcj12138aaa.github.io//tag/VSWLYuWEZR" class="tag">Spring</a>
            
        </span>
            <h1>ä¸€èµ·å­¦ Spring ä¹‹ å¼‚å¸¸å¤„ç†</h1>
            <span class="meta">
            	Posted on
              2019-05-18ï¼Œ12 min read
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Post Content -->
  <article>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <figure data-type="image" tabindex="1"><img src="http://ww1.sinaimg.cn/large/006tNc79ly1g35nzax5gvj30p00dwtaq.jpg" alt="å…¬ä¼—å·"></figure>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>è¿™æ¬¡æˆ‘ä»¬å­¦ä¹  Spring çš„å¼‚å¸¸å¤„ç†ï¼Œä½œä¸ºä¸€ä¸ª Spring ä¸ºåŸºç¡€æ¡†æ¶çš„ Web ç¨‹åºï¼Œå¦‚æœä¸å¯¹ç¨‹åºä¸­å‡ºç°çš„å¼‚å¸¸è¿›è¡Œé€‚å½“çš„å¤„ç†æ¯”å¦‚å¼‚å¸¸ä¿¡æ¯å‹å¥½åŒ–ï¼Œè®°å½•å¼‚å¸¸æ—¥å¿—ç­‰ç­‰ï¼Œç›´æ¥å°†å¼‚å¸¸ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯å±•ç¤ºç»™ç”¨æˆ·ï¼Œå¯¹ç”¨æˆ·ä½“éªŒæœ‰ä¸å¥½çš„å½±å“ã€‚æ‰€ä»¥æœ¬ç¯‡æ–‡ç« ä¸»è¦æ¢è®¨é€šè¿‡ Spring è¿›è¡Œç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„å‡ ç§æ–¹å¼å®ç°ï¼Œä»¥æ›´ä¼˜é›…çš„æ–¹å¼æ•è·ç¨‹åºå‘ç”Ÿçš„å¼‚å¸¸ä¿¡æ¯å¹¶è¿›è¡Œé€‚å½“çš„å¤„ç†å“åº”ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦å†…å®¹æ¶‰åŠå¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p><code>HandlerExceptionResolver</code> æ‰©å±•</p>
</li>
<li>
<p><code>@ExceptionHandler</code> å’Œ <code>@ControllerAdvice</code> ä½¿ç”¨</p>
</li>
<li>
<p><code>ResponseEntityExceptionHandler</code> æ‰©å±•</p>
</li>
<li>
<p><code>ResponseStatusException</code> ä½¿ç”¨</p>
</li>
<li>
<p>Spring Boot <code>ErrorController</code> æ‰©å±•</p>
</li>
</ul>
<blockquote>
<p>ç¤ºä¾‹é¡¹ç›®ï¼š</p>
<ul>
<li>spring-exception-handler: https://github.com/wrcj12138aaa/spring-exception-handler</li>
</ul>
<p>ç¯å¢ƒæ”¯æŒï¼š</p>
<ul>
<li>
<p>JDK 8</p>
</li>
<li>
<p>SpringBoot 2.1.4</p>
</li>
<li>
<p>Maven 3.6.0</p>
</li>
</ul>
</blockquote>
<h2 id="æ­£æ–‡">æ­£æ–‡</h2>
<p>Spring æ¡†æ¶çš„å¼‚å¸¸å¤„ç†æä¾›äº†è®¸å¤šç§æ–¹å¼ï¼Œåœ¨ Spring 3.2 ä¹‹å‰ä¸»è¦æœ‰ä¸¤ç§å¤„ç†æ–¹å¼ï¼šæ‰©å±• <code>HandlerExceptionResolver</code> å’Œ ä½¿ç”¨æ³¨è§£ <a href="https://docs.spring.io/spring/docs/5.1.6.RELEASE/spring-framework-reference/web.html#mvc-ann-exceptionhandler">@ExceptionHandler</a>ï¼ŒSpring 3.2 ä¹‹åæä¾›äº†æ›´ä¸°å¯Œçš„å¤„ç†æ–¹å¼ã€‚</p>
<h3 id="handlerexceptionresolver-æ‰©å±•">HandlerExceptionResolver æ‰©å±•</h3>
<p><code>HandlerExceptionResolver</code> æ˜¯ä¸€ä¸ªå¤„ç† Web ç¨‹åºå‘ç”Ÿå¼‚å¸¸æ—¶çš„æ¥å£ï¼Œæ¥å£æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">@Nullable
ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, @Nullable Object handler, Exception ex);
</code></pre>
<p>ä»è¿”å›å€¼ç±»å‹ <code>ModelAndView</code> å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå±äº Spring MVC æ¡†æ¶ä¸­çš„æ¥å£ï¼Œå®ç°æ­¤æ–¹æ³•å°±å¯ä»¥å¯¹æ•è·çš„å¼‚å¸¸è¿›è¡Œè§£æå¤„ç†ï¼Œç„¶åæ ¹æ®è‡ªèº«éœ€è¦è¿”å› <code>ModelAndView</code> å¯¹è±¡ï¼Œä»¥ JSON æ•°æ®æˆ–è€…é¡µé¢å½¢å¼å“åº”å®¢æˆ·ç«¯è¯·æ±‚ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ä¸‹ <code>HandlerExceptionResolver</code> ç±»å±‚æ¬¡ä½“ç³»ï¼ŒSpring æä¾›äº† 4 ä¸ªå®ç°ç±»ï¼Œä¸‹é¢æ ¹æ®è¿™äº›ç±»åšäº†ç®€å•çš„æè¿°ã€‚</p>
<figure data-type="image" tabindex="2"><img src="http://ww4.sinaimg.cn/large/006tNc79ly1g35oldz1g8j31560a10u1.jpg" alt="HandlerExceptionResolver ç±»ä½“ç³»"></figure>
<table>
<thead>
<tr>
<th>HandlerExceptionResolver</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SimpleMappingExceptionResolver</code></td>
<td>æ˜ å°„å¼‚å¸¸ç±»åˆ°æŒ‡å®šè§†å›¾ï¼Œä¸€èˆ¬ç”¨äºå±•ç°å¼‚å¸¸å‘ç”Ÿæ—¶çš„é”™è¯¯é¡µé¢</td>
</tr>
<tr>
<td><code>DefaultHandlerExceptionResolver</code></td>
<td><code>HandlerExceptionResolver</code> çš„é»˜è®¤å®ç°ï¼Œå¤„ç† Spring MVC å¼‚å¸¸</td>
</tr>
<tr>
<td><code>ResponseStatusExceptionResolver</code></td>
<td>å¤„ç†å¸¦æœ‰ <code>@ResponseStatus</code> æ³¨è§£çš„å¼‚å¸¸ï¼Œå°†æ³¨è§£ä¸Šå¯¹åº”çš„å€¼è½¬æ¢ä¸º HTTP çŠ¶æ€ç ï¼Œä¸€èˆ¬æ”¾äºè‡ªå®šä¹‰çš„å¼‚å¸¸ç±»ä¸Š</td>
</tr>
<tr>
<td><code>ExceptionHandlerExceptionResolver</code></td>
<td>å¤„ç†å¸¦æœ‰ <code>@ExceptionHandler</code>æ³¨è§£çš„å¼‚å¸¸</td>
</tr>
</tbody>
</table>
<p>å½“æˆ‘ä»¬éœ€è¦å®ç°è‡ªå®šä¹‰çš„ <code>HandlerExceptionResolver</code>æ—¶ï¼Œåªè¦é€šè¿‡ç»§æ‰¿å®ƒçš„æŠ½è±¡ç±» <code>AbstractHandlerExceptionResolver</code>ï¼Œè¦†å†™ <code>doResolveException</code>æ–¹æ³•å°±å¯ä»¥äº†ã€‚</p>
<p>ä¸‹æ–¹çš„ç¤ºä¾‹ä»£ç å¤„ç†äº†ç¨‹åºä¸­å‘ç”Ÿçš„ <code>IllegalArgumentException</code> å¼‚å¸¸æ—¶çš„æƒ…å†µï¼Œå¹¶é€šè¿‡ <code>MappingJackson2JsonView</code> å¯¹è±¡è¿”å›å®¢æˆ·ç«¯ä¸€ä¸ª JSON æ•°æ®å¯¹è±¡ã€‚å¦‚æœä¸æ˜¯ <code>IllegalArgumentException</code>å¼‚å¸¸ï¼Œè¿”å› <code>null</code> è¡¨ç¤ºè®©å…¶ä»–å¼‚å¸¸å¤„ç†å™¨è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œç”±äºå¼‚å¸¸å¤„ç†é“¾æœºåˆ¶ï¼Œå¦‚æœä¸å¤„ç†å¼‚å¸¸ï¼Œå°±ä¼šç”± Web å®¹å™¨å°†å¼‚å¸¸è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<pre><code class="language-java">@Component
public class RestResponseStatusExceptionResolver extends AbstractHandlerExceptionResolver {

    @Override
    protected ModelAndView doResolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        try {
            if (ex instanceof IllegalArgumentException) {
                ModelAndView modelAndView = new ModelAndView();
                Map&lt;String, String&gt; maps = new HashMap&lt;&gt;();
                maps.put(&quot;code&quot;, &quot;400&quot;);
                maps.put(&quot;message&quot;, ex.getClass().getName());
                maps.put(&quot;data&quot;, null);
                MappingJackson2JsonView mappingJackson2JsonView = new MappingJackson2JsonView();
                mappingJackson2JsonView.setAttributesMap(maps);
                modelAndView.setView(mappingJackson2JsonView);
                return modelAndView;
            }
        } catch (Exception handlerException) {
            logger.warn(&quot;Handling of [&quot; + ex.getClass().getName() + &quot;] resulted in Exception&quot;, handlerException);
        }
        return null;
    }

}
</code></pre>
<p>æˆ‘ä»¬ä½¿ç”¨ Postman å·¥å…·æ¨¡æ‹Ÿè¯·æ±‚é¡¹ç›®çš„ API æ¥å£ <code>/exception1</code> æ¥å¯¼è‡´å¼‚å¸¸çš„è§¦å‘ï¼Œæ­£å¸¸å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ•ˆæœï¼š</p>
<figure data-type="image" tabindex="3"><img src="http://ww2.sinaimg.cn/large/006tNc79ly1g35e6h2qntj30f80bvq3f.jpg" alt="image-20190518131151510"></figure>
<h3 id="exceptionhandler">@ExceptionHandler</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ <code>@ExceptionHandler</code> çš„ç”¨æ³•ï¼Œè¿™ä¸ªæ³¨è§£é€šå¸¸å®šä¹‰åœ¨æŸä¸ªæ§åˆ¶å™¨ä¸‹çš„æ–¹æ³•é‡Œï¼Œè¡¨æ˜å¤„ç†è¯¥æ§åˆ¶å™¨å‡ºç°çš„æŒ‡å®šå¼‚å¸¸, å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<pre><code class="language-java">@RestController
public class RestApiController {
    //...

    @ExceptionHandler({IllegalStateException.class})
    public ModelAndView handleIllegalStateException(IllegalStateException ex) {
        System.out.println(&quot;éæ³•çŠ¶æ€å¼‚å¸¸å‡ºç°,éœ€è¦å¤„ç† &quot; + ex.getMessage());
        ModelAndView modelAndView = new ModelAndView();
        Map&lt;String, String&gt; maps = new HashMap&lt;&gt;();
        maps.put(&quot;data&quot;, null);
        maps.put(&quot;message&quot;, ex.getClass().getName());
        maps.put(&quot;code&quot;, &quot;400&quot;);
        MappingJackson2JsonView mappingJackson2JsonView = new MappingJackson2JsonView();
        mappingJackson2JsonView.setAttributesMap(maps);
        modelAndView.setView(mappingJackson2JsonView);
        return modelAndView;
    }
}
</code></pre>
<blockquote>
<p><code>@ExceptionHandler</code> å¯ä»¥è®¾ç½®å¤šä¸ªéœ€è¦æ•è·å¤„ç†çš„å¼‚å¸¸ç±»å‹ï¼Œä¹Ÿå¯ä»¥ä¸å¡«é»˜è®¤ä¸ºæ‰€æœ‰å¼‚å¸¸ç±»,æ›´å¤šä¿¡æ¯å¯ä»¥æŸ¥çœ‹ <a href="https://docs.spring.io/spring/docs/5.1.6.RELEASE/spring-framework-reference/web.html#mvc-ann-exceptionhandler">mvc-ann-exceptionhandler</a></p>
</blockquote>
<p>ç„¶åä½¿ç”¨ Postman å·¥å…·æ¨¡æ‹Ÿè¯·æ±‚é¡¹ç›®çš„ API æ¥å£ <code>/exception2</code> æ¥è§¦å‘å¼‚å¸¸ï¼Œçœ‹ä¸‹å“åº”æ•°æ®ï¼š</p>
<figure data-type="image" tabindex="4"><img src="http://ww4.sinaimg.cn/large/006tNc79ly1g35f7qidfcj30gn0c0aaj.jpg" alt="image-20190518134744575"></figure>
<p>è¿™æ ·æ–¹å¼ä½¿ç”¨ <code>@ExceptionHandler</code> å­˜åœ¨ä¸€ä¸ªç¼ºé™·ï¼Œå°±æ˜¯åªä¼šé’ˆå¯¹å½“å‰æ§åˆ¶å™¨ä¸‹çš„å¼‚å¸¸å¤„ç†ï¼Œè‹¥éœ€è¦å®ç°å…¨å±€æ§åˆ¶å™¨çš„å¼‚å¸¸å¤„ç†ï¼Œè¿˜éœ€è¦é…åˆæ³¨è§£ <code>@ControllerAdvice</code> ä¸€èµ·ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥å°±ä»‹ç»è¿™ä¸ªå¤„ç†æ–¹å¼ã€‚</p>
<h3 id="controlleradvice">@ControllerAdvice</h3>
<p>Spring 3.2 å¼•å…¥äº†ä¸€ç§æ–°æ³¨è§£ <code>@ControllerAdvice</code>ï¼Œç”¨äºå°†æ‰€æœ‰æ§åˆ¶å™¨ä¸­å¼‚å¸¸çš„å¤„ç†æ”¾åœ¨ä¸€å¤„è¿›è¡Œï¼Œå°†æŒ‡å®šä¸€ä¸ªç±»ä½œä¸ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œç”¨ <code>@ExceptionHandler</code> æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å»å¤„ç†å¼‚å¸¸ï¼Œå…·ä½“ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">@ControllerAdvice
public class NormalExceptionHandler {
    @ExceptionHandler()
    public ResponseEntity handleException(Exception e) {
        System.out.println(&quot;NormalExceptionHandler handle exception&quot;);
        return ResponseEntity.ok(new Result&lt;&gt;(400, e.getMessage(), null));
    }
}
</code></pre>
<blockquote>
<p>ä»£ç ä¸­çš„ Result å¯¹è±¡åªæ˜¯ä¸€ä¸ªæ•°æ®ä¼ è¾“å¯¹è±¡ (DTO)ï¼Œä¾¿äºè¿”å›å®¢æˆ·ç«¯ç»Ÿä¸€æ ¼å¼çš„æ•°æ®ã€‚</p>
</blockquote>
<p>å†æ¥çœ‹ä¸‹ä½¿ç”¨ Postman å·¥å…·æ¨¡æ‹Ÿè¯·æ±‚ API æ¥å£ <code>/exception3</code> å“åº”çš„æ•°æ®ï¼Œè§ä¸‹å›¾ã€‚</p>
<figure data-type="image" tabindex="5"><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g35guihk8ej30bk0b5mxh.jpg" alt="image-20190518144403940"></figure>
<p>è¿˜æœ‰ä¸€ä¸ªæ³¨è§£ <code>@RestControllerAdvice</code> è·Ÿ <code>@ControllerAdvice</code> å¾ˆç›¸ä¼¼ï¼Œå…¶å®å°±æ˜¯ <code>@ControllerAdvice</code> ä¸ <code>@ResponseBody</code>æ³¨è§£çš„ç»„åˆï¼Œæ•ˆæœå°±æ˜¯å¼‚å¸¸å¤„ç†æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œç›´æ¥å°±ä¼šè¢«åºåˆ—åŒ–æˆ JSON æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">@RestControllerAdvice
public class RestExceptionHandler {
    @ExceptionHandler({ArithmeticException.class})
    public Result handlerException(Exception e) {
        return new Result&lt;&gt;(400, e.getMessage(), null);
    }
}
</code></pre>
<p>è¿™ä¸ªæ³¨è§£æ˜¯åœ¨ Spring 4.3 ç‰ˆæœ¬å¼•å…¥çš„ï¼Œä¸»è¦å°±æ˜¯ä¾¿äºé’ˆå¯¹ REST è¯·æ±‚å¼‚å¸¸æ—¶ç›´æ¥è¿”å› JSON æ ¼å¼çš„æ•°æ®ï¼Œè€Œä¸ä½¿ç”¨ <code>ResponseEntity</code> å¯¹è±¡æ–¹å¼ä¼ é€’æ•°æ®ã€‚</p>
<p><code>@ControllerAdvice</code> é»˜è®¤æ‹¦æˆªæ‰€æœ‰æ§åˆ¶å™¨ä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é™å®šèŒƒå›´ï¼Œé™å®šæ–¹å¼æœ‰é™å®šæ³¨è§£ï¼ŒåŒ…åç­‰ï¼Œå…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">// Target all Controllers annotated with @RestController
@ControllerAdvice(annotations = RestController.class)
public class ExampleAdvice1 {}

// Target all Controllers within specific packages
@ControllerAdvice(&quot;org.example.controllers&quot;)
public class ExampleAdvice2 {}

// Target all Controllers assignable to specific classes
@ControllerAdvice(assignableTypes = {ControllerInterface.class, AbstractController.class})
public class ExampleAdvice3 {}
</code></pre>
<p>å¯¹äº å…¨å±€ <code>@ExceptionHandler</code> æ–¹æ³•å¤„ç†çš„æè¿°ï¼Œå®˜æ–¹æ–‡æ¡£è¿˜æœ‰é¢å¤–çš„å¤‡æ³¨å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Global <code>@ExceptionHandler</code> methods (from a <code>@ControllerAdvice</code>) are applied <em>after</em> local ones (from the <code>@Controller</code>).</p>
</blockquote>
<p>è¿™è¡¨æ˜äº†å¼‚å¸¸å¤„ç†ä¹Ÿå­˜åœ¨ä¼˜å…ˆçº§ï¼Œå…ˆäº¤ç»™å½“å‰æ§åˆ¶å™¨å†…çš„ <code>@ExceptionHandler</code>æ–¹æ³•å¤„ç†ï¼Œè‹¥æœªå¤„ç†å†ç”±å…¨å±€çš„<code>@ExceptionHandler</code> æ–¹æ³•å¤„ç†ã€‚</p>
<h3 id="responseentityexceptionhandler-æ‰©å±•">ResponseEntityExceptionHandler æ‰©å±•</h3>
<p><code>ResponseEntityExceptionHandler</code> ç±»æ˜¯ä¸»è¦é’ˆå¯¹ Spring MVC æ‰€æŠ›å‡ºå¼‚å¸¸çš„å¤„ç†ç±»ï¼Œæ¯”å¦‚ 405 è¯·æ±‚ï¼Œ400 è¯·æ±‚ç­‰ï¼Œéƒ½é»˜è®¤ç”± <code>ResponseEntityExceptionHandler</code>å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥è¿‡ç»§æ‰¿è¿™ä¸ªç±»è¦†å†™å®ƒçš„æ–¹æ³•ï¼Œæ¥å®ç°ç‰¹å®šè¯·æ±‚å¼‚å¸¸çš„å¤„ç†ã€‚æ¯”å¦‚ä¸‹é¢ä»£ç å®ç°å¯¹ 405 è¯·æ±‚å¼‚å¸¸çš„å“åº”å¤„ç†ã€‚</p>
<pre><code class="language-java">@@ControllerAdvice
public class CustomWebResponseEntityExceptionHandler extends ResponseEntityExceptionHandler {
    @Override
    protected ResponseEntity&lt;Object&gt; handleHttpRequestMethodNotSupported(HttpRequestMethodNotSupportedException ex, HttpHeaders headers, HttpStatus status, WebRequest request) {
        switch (status) {
            case METHOD_NOT_ALLOWED:
                return getMethodNotAllowedResponse(request);
            default:
                return ResponseEntity.ok(new Result&lt;&gt;(status.value(), status.getReasonPhrase(), null));
        }
    }

    public ResponseEntity getMethodNotAllowedResponse(WebRequest request) {
        String uri = &quot;&quot;;
        if (request instanceof ServletWebRequest) {
            uri = ((ServletWebRequest) request).getRequest().getRequestURI();
        }
        Result&lt;Object&gt; result = new Result&lt;&gt;();
        result.setCode(HttpStatus.METHOD_NOT_ALLOWED.value());
        result.setMessage(uri + &quot; è¯·æ±‚æ–¹å¼ä¸æ­£ç¡®&quot;);
        return ResponseEntity.ok(result);
    }
}
</code></pre>
<p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å°è¯•å‘é€ GET è¯·æ±‚ç»™ API æ¥å£<code>/hello</code>,ä¼šæœ‰å¦‚ä¸‹è¿”å›ä¿¡æ¯ï¼š</p>
<figure data-type="image" tabindex="6"><img src="http://ww4.sinaimg.cn/large/006tNc79ly1g35jsrjw5jj30e50c3jru.jpg" alt="image-20190518162624412"></figure>
<p>å½“æ—¶ <code>ResponseEntityExceptionHandler</code> ä¹Ÿå­˜åœ¨å±€é™æ€§ï¼Œç›®å‰æ”¯æŒçš„ SpringMVC æ ‡å‡†å¼‚å¸¸åªæœ‰ä¸‹é¢ 15 ç§å¼‚å¸¸ç±»å‹:</p>
<ul>
<li><code>HttpRequestMethodNotSupportedException</code></li>
<li><code>HttpMediaTypeNotSupportedException</code></li>
<li><code>HttpMediaTypeNotAcceptableException</code></li>
<li><code>MissingPathVariableException</code></li>
<li><code>MissingServletRequestParameterException</code></li>
<li><code>ServletRequestBindingException</code></li>
<li><code>ConversionNotSupportedException</code></li>
<li><code>TypeMismatchException</code></li>
<li><code>HttpMessageNotReadableException</code></li>
<li><code>HttpMessageNotWritableException</code></li>
<li><code>MethodArgumentNotValidException</code></li>
<li><code>MissingServletRequestPartException</code></li>
<li><code>BindException</code></li>
<li><code>NoHandlerFoundException</code></li>
<li><code>AsyncRequestTimeoutException</code></li>
</ul>
<h3 id="responsestatusexception">ResponseStatusException</h3>
<p><code>ResponseStatusException</code>ç±»æ˜¯åœ¨ Spring 5.0 å¼•å…¥ï¼Œå…³è” HTTP çŠ¶æ€ç å’Œå¯é€‰çš„åŸå› ï¼Œæˆ‘ä»¬ç›´æ¥å°±å¯ä»¥åœ¨è¯·æ±‚æ–¹æ³•ä¸­æ„å»ºè¿™ä¸ªå¼‚å¸¸å¯¹è±¡è¿›è¡Œè¿”å›ï¼Œä½¿ç”¨èµ·æ¥ååˆ†ç®€å•ï¼š</p>
<pre><code class="language-java">@GetMapping(&quot;/exception4&quot;)
public ResponseEntity&lt;String&gt; exception4(String param) {
    throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;èµ„æºæœªæ‰¾åˆ°&quot;);
}
</code></pre>
<p>ä½¿ç”¨è¿™ç§æ–¹å¼è™½ç„¶èƒ½ç›´æ¥è¿”å›å“åº”ç å’Œå…·ä½“åŸå› ï¼Œä½†æ˜¯æ²¡æœ‰ç»Ÿä¸€å¤„ç†å¼‚å¸¸çš„æ•ˆæœï¼Œé€šå¸¸é…åˆ <code>@ControllerAdvice</code> ä¸€èµ·ç»„åˆä½¿ç”¨ã€‚</p>
<h3 id="spring-boot-errorcontroller">Spring Boot ErrorController</h3>
<p><code>ErrorController</code> æ˜¯ Spring Boot 2.0 å¼•å…¥æ¥å£ï¼ŒåŸºäºæ­¤çš„å®ç°ç±» <code>org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController</code> ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§é€šç”¨çš„æ–¹å¼è¿›è¡Œé”™è¯¯å¤„ç†, ä¸‹é¢æ˜¯è¿™ä¸ªå®ç°ç±»çš„å…³é”®æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@RequestMapping(produces = MediaType.TEXT_HTML_VALUE)
public ModelAndView errorHtml(HttpServletRequest request,
        HttpServletResponse response) {
    HttpStatus status = getStatus(request);
    Map&lt;String, Object&gt; model = Collections.unmodifiableMap(getErrorAttributes(
            request, isIncludeStackTrace(request, MediaType.TEXT_HTML)));
    response.setStatus(status.value());
    ModelAndView modelAndView = resolveErrorView(request, response, status, model);
    return (modelAndView != null) ? modelAndView : new ModelAndView(&quot;error&quot;, model);
}

@RequestMapping
public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) {
    Map&lt;String, Object&gt; body = getErrorAttributes(request,
            isIncludeStackTrace(request, MediaType.ALL));
    HttpStatus status = getStatus(request);
    return new ResponseEntity&lt;&gt;(body, status);
}
</code></pre>
<p>å¯ä»¥ä»è¿™ä¸¤ä¸ªæ–¹æ³•çœ‹å‡ºé’ˆå¯¹é”™è¯¯è¯·æ±‚ï¼Œ<code>BasicErrorController</code> æä¾›äº†ä¸¤ç§æ•°æ®å½¢å¼çš„è¿”å›ï¼Œä¸€ç§æ˜¯ HTML é¡µé¢ï¼Œä¸€ç§æ˜¯ JSON æ•°æ®ï¼›å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨æµè§ˆå™¨è®¿é—®æ¥å£çš„è¯è§åˆ°çš„å°±æ˜¯ <code>errorHtml</code>æ–¹æ³•è¿”å›çš„ HTML é¡µé¢æ•°æ®ï¼Œå®ƒä»¬çš„åŒºåˆ«å°±åœ¨äºè¯·æ±‚æ—¶ Header é‡Œ Accept å€¼çš„ä¸åŒã€‚</p>
<figure data-type="image" tabindex="7"><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g35ktpalx1j313n0doq53.jpg" alt="image-20190518170154527"></figure>
<p>å¦å¤–ï¼ŒSpring Boot æä¾›ç»Ÿä¸€é”™è¯¯ä¿¡æ¯å¤„ç†ï¼Œæ˜¯å…è®¸å…³é—­çš„ï¼Œåªè¦åœ¨é…ç½®æ–‡ä»¶ <code>application.properties</code> è®¾ç½® <code>server.error.whitelabel.enabled</code> ä¸º <code>false</code>å³å¯ã€‚</p>
<pre><code class="language-properties">server.error.whitelabel.enabled=false
</code></pre>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åŸºäºæ­¤è¿›è¡Œæ‰©å±•ï¼Œæ¯”å¦‚å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„é”™è¯¯æ§åˆ¶å™¨ï¼Œç»§æ‰¿ <code>BasicErrorController</code>,ç¼–å†™è‡ªå·±çš„é”™è¯¯å±•ç¤ºé€»è¾‘å’Œå†…å®¹ï¼Œæ¯”å¦‚ä¸‹é¢ä»£ç ï¼š</p>
<pre><code class="language-java">@Component
public class CustomErrorController extends BasicErrorController {

    public CustomErrorController(ErrorAttributes errorAttributes) {
        super(errorAttributes, new ErrorProperties());
    }

    @RequestMapping(produces = MediaType.APPLICATION_XML_VALUE)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; xmlError(HttpServletRequest request, HttpStatus status) {
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;code&quot;, status.value());
        map.put(&quot;message&quot;, status.getReasonPhrase());
        return ResponseEntity.ok(map);
    }
}
</code></pre>
<p>å®ç°çš„ <code>CustomErrorController</code> é’ˆå¯¹è¯·æ±‚æ—¶ Aceept ä¸º <code>application/xml</code>çš„å‘ç”Ÿçš„å¼‚å¸¸éƒ½ç»Ÿä¸€ä»¥ XML æ ¼å¼è¿›è¡Œè¿”å›ï¼Œå¦‚å›¾ï¼š</p>
<figure data-type="image" tabindex="8"><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g35lc9jwkyj30er0ebwf1.jpg" alt="image-20190518171944860"></figure>
<blockquote>
<p>æ³¨æ„: Spring Boot é»˜è®¤ä¸æ”¯æŒæ•°æ®è¿›è¡Œ XML æ ¼å¼çš„è½¬æ¢ï¼ŒPOM æ–‡ä»¶éœ€è¦é¢å¤–æ·»åŠ ä¾èµ–åº“ï¼š</p>
<pre><code class="language-xml">&lt;dependency&gt;
      &lt;groupId&gt;com.fasterxml.jackson.dataformat&lt;/groupId&gt;
      &lt;artifactId&gt;jackson-dataformat-xml&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
</blockquote>
<h2 id="ç»“è¯­">ç»“è¯­</h2>
<p>æœ¬æ–‡æˆ‘ä»¬ä¸»è¦å­¦ä¹ äº† Spring æ¡†æ¶ 5 ç§å¼‚å¸¸å¤„ç†çš„æ–¹å¼ä»¥åŠ Spring Boot çš„é€šç”¨å¼‚å¸¸å¤„ç†è¡Œä¸ºï¼Œå½¢å¼å¤šæ ·ï¼Œä½†å…·ä½“æƒ…å†µéœ€è¦å…·ä½“å®šåˆ¶ï¼Œä¸ºäº†ä¿è¯ç¨‹åºçš„å¥å£®æ€§å’Œä¾¿äºå¿«é€Ÿå®šä½è¯·æ±‚å‡ºç°çš„å¼‚å¸¸é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºç¨‹åºæä¾›ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æ–¹å¼ï¼Œä¹Ÿåœ¨å¹³æ—¶çš„é¡¹ç›®é‡Œä½¿ç”¨èµ·æ¥å§ã€‚</p>
<p>å¦‚æœè¯»å®Œè§‰å¾—æœ‰æ”¶è·çš„è¯ï¼Œæ¬¢è¿ç‚¹ã€å¥½çœ‹ã€‘ï¼Œç‚¹å‡»æ–‡ç« å¤´å›¾ï¼Œæ‰«ç å…³æ³¨ã€é—»äººçš„æŠ€æœ¯åšå®¢ã€‘ğŸ˜„ğŸ˜„ğŸ˜„ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li>Spring Boot ä¸­ Web åº”ç”¨çš„ç»Ÿä¸€å¼‚å¸¸å¤„ç† : http://blog.didispace.com/springbootexception</li>
<li>Error Handling for REST with Spring : https://www.baeldung.com/exception-handling-for-rest-with-spring</li>
<li>Spring REST Service Exception Handling https://dzone.com/articles/spring-rest-service-exception-handling-1</li>
<li>mvc-ann-exceptionhandlerï¼šhttps://docs.spring.io/spring/docs/5.1.6.RELEASE/spring-framework-reference/web.html#mvc-ann-exceptionhandler</li>
<li>spring-boot-return-json-and-xml-from-controllers: https://stackoverflow.com/questions/27790998/spring-boot-return-json-and-xml-from-controllers</li>
<li>Spring Web MVC Exceptions : https://docs.spring.io/spring/docs/5.1.6.RELEASE/spring-framework-reference/web.html#mvc-exceptionhandlers</li>
</ul>

          
          <p class="next-post">ä¸‹ä¸€ç¯‡ï¼š
            <a href="https://wrcj12138aaa.github.io//post/20190511-ä¸€èµ·å­¦ Spring ä¹‹ RestTemplate">
              <span class="post-title">
                ä¸€èµ·å­¦ Spring ä¹‹ RestTemplate&rarr;
              </span>
            </a>
          </p>
        
        <div class="comment">
          
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script>
  var gitalk = new Gitalk({
    clientID: '2ba76d6fe50ad2b384eb',
    clientSecret: '90db763ed48942571725d6aef11229900c8bb656',
    repo: 'wrcj12138aaa.github.io',
    owner: 'wrcj12138aaa',
    admin: ['wrcj12138aaa'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })
  gitalk.render('gitalk-container')
</script>

          
          
        
        </div>
      </div>
    </div>
  </article>
 <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li class="list-inline-item">
              <a href="https://wrcj12138aaa.github.io//atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li>
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>é—»äººçš„æŠ€æœ¯åšå®¢</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://wrcj12138aaa.github.io//media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://wrcj12138aaa.github.io//media/scripts/clean-blog.min.js"></script> -->
  <script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>â–²</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  </body>
</html>

