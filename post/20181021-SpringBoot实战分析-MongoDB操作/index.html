<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta content="yes" name="apple-mobile-web-app-capable" />
  <meta content="black" name="apple-mobile-web-app-status-bar-style" />
  <meta name="referrer" content="never">
  <meta name="keywords" content="">
  <meta name="description" content="">
  <meta name="author" content="kveln">
  <title>SpringBootå®æˆ˜åˆ†æ-MongoDBæ“ä½œ | é—»äººçš„æŠ€æœ¯åšå®¢</title>
  <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="https://wrcj12138aaa.github.io//media/css/bootstrap.min.css" rel="stylesheet"> -->
  <!--  <link href="https://wrcj12138aaa.github.io//media/css/all.min.css" rel="stylesheet" type="text/css"> -->
  <link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  <link rel="alternate" type="application/rss+xml" title="SpringBootå®æˆ˜åˆ†æ-MongoDBæ“ä½œ | é—»äººçš„æŠ€æœ¯åšå®¢ Â» Feed" href="https://wrcj12138aaa.github.io//atom.xml">
  <link rel="stylesheet"href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css">
  <link href="https://wrcj12138aaa.github.io//styles/main.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/highlight.min.js"></script>
  <!-- <script src="https://wrcj12138aaa.github.io//media/scripts/jquery.min.js"></script> -->
  <script>hljs.initHighlightingOnLoad();</script>
  

    <meta property="og:description" content="SpringBootå®æˆ˜åˆ†æ-MongoDBæ“ä½œ"/>
    <meta property="og:url" content="https://wrcj12138aaa.github.io//post/20181021-SpringBootå®æˆ˜åˆ†æ-MongoDBæ“ä½œ"/>
    <meta property="og:locale" content="zh-CN"/>
    <meta property="og:type" content="website"/>
    <meta property="og:site_name" content="é—»äººçš„æŠ€æœ¯åšå®¢"/>
  </head>
  <body>
  	<!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="https://wrcj12138aaa.github.io/">é—»äººçš„æŠ€æœ¯åšå®¢</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          
          <li class="nav-item">
              
              <a class="nav-link" href="/">é¦–é¡µ</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/archives">å½’æ¡£</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/tags">æ ‡ç­¾</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/post/about">å…³äº</a>
              
          </li>
          
        </ul>
      </div>
    </div>
  </nav>
  <!-- Page Header -->
  <header class="masthead" style="background-image: url('https://wrcj12138aaa.github.io//media/images/home-bg.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
          	<span class="tags">
          	 
            <a href="https://wrcj12138aaa.github.io//tag/rqKiVec5UR" class="tag">SpringBoot</a>
            
        </span>
            <h1>SpringBootå®æˆ˜åˆ†æ-MongoDBæ“ä½œ</h1>
            <span class="meta">
            	Posted on
              2018-10-21ï¼Œ12 min read
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Post Content -->
  <article>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <h2 id="å‰è¨€">å‰è¨€</h2>
<p><code>MongoDB</code>ä½œä¸ºä¸€ä¸ªåŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“,åœ¨å¾®æœåŠ¡é¢†åŸŸä¸­å¹¿æ³›ä½¿ç”¨.æœ¬ç¯‡æ–‡ç« å°†å­¦ä¹  <code>Spring Boot</code> ç¨‹åºå¦‚ä½•æ‰§è¡Œ <code>MongoDB</code> æ“ä½œä»¥åŠåº•å±‚å®ç°æ–¹å¼çš„æºç åˆ†æ,æ¥æ›´å¥½åœ°å¸®åŠ©æˆ‘ä»¬ç†è§£Springç¨‹åºæ“ä½œ <code>MongoDB</code> æ•°æ®åº“çš„è¡Œä¸º.</p>
<h2 id="æ­£æ–‡">æ­£æ–‡</h2>
<blockquote>
<p>æœ¬æ–‡ä½¿ç”¨ MongoDB æœåŠ¡å™¨ç‰ˆæœ¬ä¸º4.0.0</p>
<p>MongoDB æœåŠ¡å™¨çš„å®‰è£…å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšå®¢:<a href="https://wrcj12138aaa.github.io/2018/09/08/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E6%90%AD%E5%BB%BA%E7%B3%BB%E5%88%97%E4%B9%8BMonogDB/">åç«¯æ¶æ„æ­å»ºç³»åˆ—ä¹‹MonogDB</a></p>
</blockquote>
<h3 id="ä¸‹è½½ç¤ºä¾‹å·¥ç¨‹">ä¸‹è½½ç¤ºä¾‹å·¥ç¨‹</h3>
<p>é¦–å…ˆåœ¨<a href="https://start.spring.io/">SPRING INITIALIZR</a>ç½‘ç«™ä¸Šä¸‹è½½ç¤ºä¾‹å·¥ç¨‹,Spring Boot ç‰ˆæœ¬ä¸º1.5.17,ä»…ä¾èµ–ä¸€ä¸ª MongoDB.</p>
<figure data-type="image" tabindex="1"><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwey8cpdovj31kw0lfaer.jpg" alt="image-20181020201332247"></figure>
<p>ç”¨ IDE å¯¼å…¥å·¥ç¨‹åæ‰“å¼€POM æ–‡ä»¶,å°±å¯ä»¥çœ‹åˆ° MongoDB ä¾èµ–å¯¹åº”çš„Maven åæ ‡å’Œå¯¹åº”ç¬¬ä¸‰æ–¹åº“ä¸º <code>spring-boot-starter-data-mongodb</code></p>
<pre><code class="language-xml">&lt;dependency&gt;
	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>é‚£ä»¥åæˆ‘ä»¬è¦åœ¨<code>Spring Boot</code>é¡¹ç›®ä½¿ç”¨ <code>MongoDB</code> æ—¶å°±å¯ä»¥åœ¨ä¸» <code>POM</code>æ–‡ä»¶ä¸­å¼•å…¥è¿™ä¸ªåº“çš„åæ ‡å°±OK äº†.</p>
<p>è€Œ <code>spring-boot-starter-data-mongodb</code> æ˜¯ <code>spring-data</code>çš„å­é¡¹ç›®,  å…¶ä½œç”¨å°±æ˜¯é’ˆå¯¹ <code>MongoDB</code> çš„è®¿é—®æä¾›ä¸°å¯Œçš„æ“ä½œå’Œç®€åŒ–.</p>
<h4 id="é…ç½®-mongodbè¿æ¥">é…ç½® MongoDBè¿æ¥</h4>
<p>è¦æ“ä½œ <code>MongoDB</code> æ•°æ®åº“, é¦–å…ˆè¦è®©ç¨‹åºè¿æ¥åˆ° <code>MongoDB</code> æœåŠ¡å™¨,ç”±äº <code>Spring Boot</code> å¼ºå¤§çš„ç®€åŒ–é…ç½®ç‰¹æ€§, æƒ³è¦è¿æ¥ <code>MongoDB</code> æœåŠ¡å™¨, æˆ‘ä»¬åªéœ€åœ¨èµ„æºæ–‡ä»¶å¤¹ä¸‹çš„ <code>application.properties</code>æ–‡ä»¶é‡Œæ–°å¢ä¸€è¡Œé…ç½®å³å¯.</p>
<pre><code class="language-properties">spring.data.mongodb.uri=mongodb://localhost:27017/test
</code></pre>
<blockquote>
<p>å¦‚æœè¿æ¥æœ‰ç”¨æˆ·éªŒè¯çš„ MongoDB æœåŠ¡å™¨,åˆ™uri å½¢å¼ä¸º <code>mongodb://name:password@ip:port/dbName</code></p>
</blockquote>
<h3 id="ç¼–å†™ä»£ç ">ç¼–å†™ä»£ç </h3>
<p>é…ç½®åä¹‹å,æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªå®ä½“ <code>Post</code>, åŒ…å«å±æ€§: <code>id</code>,<code>title</code>,<code>content</code>,<code>createTime</code></p>
<pre><code class="language-java">public class Post {
    @Id
    private Long id;
    private String title;
    private String content;
    private Date createTime;

    public Post() {
    }

    public Post(Long id, String title, String content) {
        this.id = id;
        this.title = title;
        this.content = content;
        this.createTime = new Date();
    }
    // çœç•¥ setter,getter æ–¹æ³•
}
</code></pre>
<p>è¿™é‡Œç”¨ æ³¨è§£<code>@Id</code>è¡¨ç¤ºè¯¥å®ä½“å±æ€§å¯¹åº”ä¸ºæ•°æ®åº“è®°å½•çš„ä¸»é”®.</p>
<p>ç„¶åå†æä¾›å¯¹Postçš„æ•°æ®è®¿é—®çš„å­˜å‚¨å¯¹è±¡ <code>PostRepository</code>, ç»§æ‰¿ å®˜æ–¹æä¾›çš„<code>MongoRepository</code>æ¥å£</p>
<pre><code class="language-java">public interface PostRepository extends MongoRepository&lt;Post,Long&gt; {
    void findByTitle(String title);
}
</code></pre>
<p>åˆ°è¿™é‡Œ å¯¹ <code>Post</code> å®ä½“çš„ <code>CRUD</code> æ“ä½œä»£ç å°±å®Œæˆ. What !!!  æˆ‘ä»¬è¿˜æ²¡å†™ä»€ä¹ˆä»£ç å°±ç»“æŸäº†ä¹ˆ? æˆ‘ä»¬ç°åœ¨å°±æ¥å†™ä¸ªæµ‹è¯•ç”¨ä¾‹æ¥çœ‹çœ‹å§.</p>
<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest
public class SpringbootMongodbApplicationTests {
	@Autowired
	private PostRepository postRepository;

	@Test
	public void testInsert() {
		Post post = new Post(1L,&quot;sayhi&quot;, &quot;hi,mongodb&quot;);
		postRepository.insert(post);
		List&lt;Post&gt; all = postRepository.findAll();
		System.out.println(all); 
        // [Post{id=1, title='sayhi', content='hi,mongodb',
        //createTime=Sat Oct 20 20:55:15 CST 2018}]
		Assert.assertEquals(all.size(),1); // true
	}
}
</code></pre>
<p>è¿è¡Œæµ‹è¯•ç”¨ä¾‹,è¿è¡Œç»“æœå¦‚ä¸‹, <code>Post</code>æ•°æ®æˆåŠŸåœ°å­˜å‚¨åˆ°äº† <code>MongoDB</code> æ•°æ®åº“ä¸­,å¹¶ä¸”èƒ½å¤ŸæŸ¥è¯¢å‡ºæ¥äº†.</p>
<figure data-type="image" tabindex="2"><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwezjdm5tlj31kw0cu0y0.jpg" alt="image-20181020205843907"></figure>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨<code>MongoDB</code> æœåŠ¡å™¨é‡ŒæŸ¥åˆ°è¿™æ¡è®°å½•:</p>
<figure data-type="image" tabindex="3"><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fwezt4iesbj31kw06bmyt.jpg" alt="image-20181020210805972"></figure>
<p>ä»è®°å½•ä¸­çœ‹åˆ°å¤šäº†ä¸ª <code>_ class</code>å­—æ®µ çš„å€¼,å…¶å®æ˜¯ç”± <code>MongoRepository</code>è‡ªåŠ¨å¸®æˆ‘ä»¬è®¾ç½®çš„,ç”¨æ¥è¡¨ç¤ºè¿™æ¡è®°å½•å¯¹åº”çš„å®ä½“ç±»å‹,ä½†åº•å±‚æ˜¯ä»€ä¹ˆæ—¶å€™æ“ä½œçš„å‘¢,æœŸå¾…åœ¨æˆ‘ä»¬åç»­åˆ†æçš„æ—¶å€™æ­æ™“ç­”æ¡ˆ.</p>
<p>æ–°å¢ä¹‹å,æˆ‘ä»¬å†å°è¯•ä¸‹æ›´æ–°æ“ä½œ,è¿™é‡Œç”¨çš„ä¹Ÿæ˜¯ç”¨ç»§æ‰¿è€Œæ¥çš„ <code>save</code> æ–¹æ³•,é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜ä½¿ç”¨äº†è‡ªå·±å†™çš„æ¥å£æ–¹æ³• <code>findByTitle</code>æ¥æ ¹æ® <code>title</code>å­—æ®µæŸ¥è¯¢å‡º Post å®ä½“.</p>
<pre><code class="language-java">@Test
public void testUpdate() {
    Post post = new Post();
    post.setId(1L);
    post.setTitle(&quot;sayHi&quot;);
    post.setContent(&quot;hi,springboot&quot;);
    post.setCreateTime(new Date());
    postRepository.save(post); // æ›´æ–° post å¯¹è±¡
    Post updatedPost = postRepository.findByTitle(&quot;sayHi&quot;); // æ ¹æ® title æŸ¥è¯¢
    Assert.assertEquals(updatedPost.getId(),post.getId());
    Assert.assertEquals(updatedPost.getTitle(),post.getTitle());
    Assert.assertEquals(updatedPost.getContent(),&quot;hi,springboot&quot;);
}
</code></pre>
<p>è¿è¡Œè¿™ä¸ªæµ‹è¯•ç”¨ä¾‹,ç»“æœä¹Ÿæ˜¯é€šè¿‡.ä½†è¿™é‡Œä¹Ÿæœ‰ä¸ªç–‘é—®: è‡ªå·±æä¾›çš„æ–¹æ³•,æ²¡æœ‰å†™å¦‚ä½•å®ç°,ç¨‹åºæ€ä¹ˆå°±èƒ½ä¾ç…§æˆ‘ä»¬æ‰€æƒ³è¦çš„:æ ¹æ®<code>title</code>å­—æ®µçš„å€¼å»æŸ¥è¯¢åˆ°åŒ¹é…åˆ°çš„è®°å½•å‘¢ ? è¿™æ ·ä¹Ÿåœ¨ä¸‹é¢å®æˆ˜åˆ†æé‡Œçœ‹ä¸ªæ˜ç™½å§.</p>
<figure data-type="image" tabindex="4"><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwf0cp9ttzj31iu0cqwhw.jpg" alt="image-20181020212654792"></figure>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯¹æ•°æ®çš„å¢,æ”¹,æŸ¥éƒ½å·²ç»è¯•è¿‡äº†,åˆ é™¤å…¶å®ä¹Ÿå¾ˆç®€å•,åªè¦è°ƒç”¨ <code>postRepository</code>çš„<code>delete</code> æ–¹æ³•å³å¯,ç°åœ¨æœ€ä¸»è¦è¿˜æ˜¯æ¢ç©¶ <code>PostRepository</code>ä»…é€šè¿‡ç»§æ‰¿<code>MongoRepository</code>å¦‚ä½•å®ç°æ•°æ®å¢åˆ æ”¹æŸ¥çš„å‘¢?</p>
<h3 id="å®æˆ˜åˆ†æ">å®æˆ˜åˆ†æ</h3>
<h4 id="postrepositoryçš„æ‰§è¡Œåº•å±‚">postRepositoryçš„æ‰§è¡Œåº•å±‚</h4>
<p>å®ç°äº†åŸºæœ¬çš„æ•°æ®æ“ä½œä¹‹å,æˆ‘ä»¬ç°åœ¨å°±æ¥çœ‹ä¸‹è¿™ä¸€åˆ‡æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢? é¦–å…ˆæˆ‘ä»¬å¯¹æµ‹è¯•ç”¨ä¾‹ <code>testUpdate</code> ä¸­çš„<code>postRepository#save</code> è¿›è¡Œæ–­ç‚¹è°ƒè¯•,è§‚å¯Ÿç¨‹åºçš„æ‰§è¡Œè·¯å¾„.åœ¨å•æ­¥è¿›å…¥ <code>save</code> æ–¹æ³•å†…éƒ¨,ä»£ç æ‰§è¡Œåˆ°äº†<code>JdkDynamicAopProxy</code>ç±»å‹ä¸‹, æ­¤æ—¶ä»£ç è°ƒç”¨é“¾å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<figure data-type="image" tabindex="5"><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fwf191ei39j31kw0k1thc.jpg" alt="image-20181020215752763"></figure>
<p>å¾ˆæ˜¾ç„¶è¿™é‡Œæ˜¯ç”¨åˆ° <code>Spring</code> çš„ <code>JDK</code> åŠ¨æ€ä»£ç†,è€Œ<code>invoke</code>æ–¹æ³•å†…è¿™ä¸ª <code>proxy</code>å¯¹è±¡ååˆ†å¼•äººæ³¨æ„, æ–¹æ³•æ‰§è¡Œæ—¶å®é™…è°ƒç”¨çš„ <code>proxy</code> çš„ <code>save</code> æ–¹æ³•,è€Œè¿™ä¸ª <code>proxy</code> åˆ™æ˜¯ <code>org.springframework.data.mongodb.repository.support.SimpleMongoRepository@8deb645</code></p>
<p>, æ˜¯ <code>SimpleMongoRepository</code> ç±»çš„å®ä¾‹.é‚£ä¹ˆæœ€åè°ƒç”¨å°±ä¼šè½åˆ°<code>SimpleMongoRepository# save</code> æ–¹æ³•ä¸­,æˆ‘ä»¬åœ¨è¿™ä¸ªæ–¹æ³•é‡Œå†æ¬¡è¿›è¡Œæ–­ç‚¹ç„¶åç»§ç»­è¿è¡Œ.</p>
<figure data-type="image" tabindex="6"><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwf1iwokc6j31fe0ioadb.jpg" alt="image-20181020220728719"></figure>
<p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,save æ–¹æ³•å†…éƒ¨æœ‰ä¸¤ä¸ªæ“ä½œ: å¦‚æœæ˜¯ä¼ å…¥çš„å®ä½“æ˜¯æ–°çºªå½•åˆ™æ‰§è¡Œ <code>insert</code>,å¦åˆ™æ‰§è¡Œ <code>save</code>æ›´æ–°æ“ä½œ.æ˜¾ç„¶ç°åœ¨è¦æ‰§è¡Œçš„æ˜¯åè€….</p>
<p>è€Œè¦å®Œæˆæ“ä½œè·Ÿä¸¤ä¸ªå¯¹è±¡ <code>entityInformation</code>å’Œ<code>mongoOperations</code>æœ‰ç€å¯†åˆ‡å…³ç³»,ä»–ä»¬åˆæ˜¯å¹²ä»€ä¹ˆçš„å‘¢,ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„å‘¢.</p>
<figure data-type="image" tabindex="7"><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwf1ruubvzj314808wwg4.jpg" alt="image-20181020221604857"></figure>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ <code>mongoOperations</code>è¿™ä¸ªå¯¹è±¡,åˆ©ç”¨<code>IDEA</code> è°ƒè¯•å·¥å…·å¯ä»¥çœ‹åˆ° <code>mongoOperations</code> å…¶å®å°±æ˜¯ <code>MongoTemplate</code>å¯¹è±¡, ç±»ä¼¼ <code>JDBCTemplate</code>,é’ˆå¯¹<code>MongoDB</code> æ•°æ®çš„å¢åˆ æ”¹æŸ¥, <code>Spring</code> ä¹Ÿé‡‡ç”¨ç›¸ä¼¼çš„åç§°æ–¹å¼å’Œ <code>API</code>.æ‰€ä»¥çœŸæ­£æ“ä½œ<code>MongoDB</code>æ•°æ®åº“åº•å±‚å°±æ˜¯è¿™ä¸ª<code>MongoTemplate</code>å¯¹è±¡.</p>
<p>è‡³äº<code>entityInformation</code>å¯¹è±¡æ‰€å±çš„ç±» <code>MappingMongoEntityInformation</code>,å­˜å‚¨ç€<code>Mongo</code>æ•°æ®å®ä½“ä¿¡æ¯,å¦‚é›†åˆåç§°,ä¸»é”®ç±»å‹,ä¸€äº›æ‰€æ˜ å°„çš„å®ä½“å…ƒæ•°æ®ç­‰.</p>
<p>å†æ¥çœ‹ä¸‹ä»–ä»¬çš„åˆå§‹åŒ–æ—¶æœº,åœ¨<code>SimpleMongoRepository</code>ç±», å¯ä»¥æ‰¾åˆ°ä»–ä»¬éƒ½åœ¨çš„æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–</p>
<pre><code class="language-java">public SimpleMongoRepository(MongoEntityInformation&lt;T, ID&gt; metadata, MongoOperations mongoOperations) {
	Assert.notNull(metadata, &quot;MongoEntityInformation must not be null!&quot;);
	Assert.notNull(mongoOperations, &quot;MongoOperations must not be null!&quot;);
    
	this.entityInformation = metadata;
	this.mongoOperations = mongoOperations;
}
</code></pre>
<p>ä»¥åŒæ ·çš„æ–¹å¼,åœ¨<code>SimpleMongoRepository</code>æ„é€ å™¨ä¸­è¿›è¡Œæ–­ç‚¹,é‡æ–°å…è®¸è§‚å¯Ÿåˆå§‹åŒ– <code>SimpleMongoRepository</code>å¯¹è±¡æ—¶çš„è°ƒç”¨é“¾.å‘ç°æ•´ä¸ªé“¾è·¯å¦‚ä¸‹,ä»è¿è¡Œæµ‹è¯•ç”¨ä¾‹åˆ°è¿™é‡Œå¾ˆé•¿çš„æ‰§è¡Œé“¾è·¯,è¿™é‡Œåªæ ‡è¯†å‡ºäº†æˆ‘ä»¬æ‰€éœ€è¦å…³æ³¨çš„é‚£äº›ç±»å’Œæ–¹æ³•.</p>
<figure data-type="image" tabindex="8"><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwfnjm23e8j30yi0s245n.jpg" alt="image-20181020224041366"></figure>
<p>ä»ä¸€å±‚å±‚æºç å¯ä»¥è·Ÿè¸ªåˆ° <code>SimpleMongoRepository</code> ç±»çš„åˆ›å»ºå’Œåˆå§‹åŒ–æ˜¯ç”± å·¥å‚ç±»<code>MongoRepositoryFactory</code>å®Œæˆ,</p>
<pre><code class="language-java">public &lt;T&gt; T getRepository(Class&lt;T&gt; repositoryInterface, Object customImplementation) {

		RepositoryMetadata metadata = getRepositoryMetadata(repositoryInterface);
		Class&lt;?&gt; customImplementationClass = null == customImplementation ? null : customImplementation.getClass();
		RepositoryInformation information = getRepositoryInformation(metadata, customImplementationClass);

		validate(information, customImplementation);

		Object target = getTargetRepository(information); // è·å–åˆå§‹åŒ–åçš„SimpleMongoRepositoryå¯¹è±¡.

		// Create proxy
		ProxyFactory result = new ProxyFactory();
		result.setTarget(target);
		result.setInterfaces(new Class[] { repositoryInterface, Repository.class }); 
    	// å¯¹ repositoryInterfaceæ¥å£ç±»è¿›è¡Œ AOP ä»£ç†

		result.addAdvice(SurroundingTransactionDetectorMethodInterceptor.INSTANCE);
		result.addAdvisor(ExposeInvocationInterceptor.ADVISOR);
    

		return (T) result.getProxy(classLoader);
}
</code></pre>
<p>ä¸‹å›¾å°±æ˜¯<code>MongoRepositoryFactory</code>çš„ç±»å›¾,è€Œ<code>MongoRepositoryFactory</code>åˆæ˜¯åœ¨<code>MongoRepositoryFactoryBean</code>ç±»é‡Œæ„é€ çš„.</p>
<figure data-type="image" tabindex="9"><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwf2pa8frjj30p40h6myd.jpg" alt="image-20181020224811986"></figure>
<p>åœ¨è°ƒç”¨é“¾çš„ä¸‹åŠæˆªé‡Œ,æˆ‘ä»¬å†çœ‹ä¸‹å‘ç”Ÿç€ä¸€åˆ‡çš„æ¥æºåœ¨å“ª, æ‰¾åˆ°  <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean</code>æ–¹æ³•,å†…éƒ¨åˆ›å»º<code>Bean</code> å®ä¾‹çš„ <code>doCreateBean</code>è°ƒç”¨å‚æ•°ä¸º<code>postRepository</code>å’Œ<code>MongoRepositoryFactoryBean</code>å®ä¾‹,ä¹Ÿå°±æ˜¯åœ¨åˆ›å»º<code>postRepository</code>å®ä¾‹çš„æ—¶å€™å®Œæˆçš„.</p>
<figure data-type="image" tabindex="10"><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwf36281mcj31660lk10j.jpg" alt="image-20181020230418830"></figure>
<p>è€Œåˆ›å»º<code>postRepository</code>å¯¹åº”å®ä½“å¯¹è±¡å®é™…ä¸º <code>MongoRepositoryFactoryBean</code>è¿™ä¸ªå·¥å‚ <code>Bean</code></p>
<figure data-type="image" tabindex="11"><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwf3tdezc8j31kw087jt8.jpg" alt="image-20181020232644057"></figure>
<p>å½“éœ€è¦ä½¿ç”¨ <code>postRepository</code>å¯¹è±¡æ—¶,å®é™…å°±æ˜¯ä½¿ç”¨å·¥å‚å¯¹è±¡çš„æ–¹æ³•<code>MongoRepositoryFactoryBean#getObject</code>è¿”å›çš„ <code>SimpleMongoRepository</code>å¯¹è±¡,è¯¦è§å½“ç±»<code>AbstractBeanFactory</code>çš„<code>doGetBean</code>æ–¹æ³•,å½“å‚æ•° <code>name</code> ä¸º <code>postRepository</code>æ—¶ä»£ç è°ƒç”¨é“¾.</p>
<figure data-type="image" tabindex="12"><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fwf4v8wm8zj31e40piqah.jpg" alt="image-20181021000306776"></figure>
<p>å¥½äº†,åˆ°è¿™é‡ŒåŸºæœ¬è¯´å®Œ <code>postRepository</code>æ˜¯å¦‚ä½•å®Œæˆ<code>MongoDB</code>æ•°æ®åº“æ“ä½œçš„,è¿˜æœ‰ä¸ªé—®é¢˜å°±æ˜¯ä»…å®šä¹‰äº†æ¥å£æ–¹æ³• <code>findByTitle</code>,å¦‚ä½•å®ç°æ ¹æ® <code>title</code> å­—æ®µæŸ¥æ‰¾çš„.</p>
<h4 id="findbytitleçš„æŸ¥æ‰¾å®ç°">findByTitleçš„æŸ¥æ‰¾å®ç°</h4>
<p>æ–­ç‚¹åˆ°æ‰§è¡Œ <code>findByTitle</code> æ–¹æ³•çš„åœ°æ–¹,è°ƒè¯•è¿›å»è·Ÿä¹‹å‰ä¸€æ ·åœ¨ <code>JdkDynamicAopProxy</code> ç±»ä¸­æ‰§è¡Œ,è€Œåœ¨è·å–è°ƒç”¨é“¾æ—¶</p>
<p>,è¿™ä¸ªä»£ç†å¯¹è±¡çš„æ‰€æ‹¥æœ‰çš„æ‹¦æˆªå™¨ä¸­ä¸€ä¸ªæ‹¦æˆªå™¨ç±»<code>org.springframework.data.repository.core.support.RepositoryFactorySupport.QueryExecutorMethodInterceptor</code>å¼•èµ·äº†æˆ‘çš„æ³¨æ„.ä»å‘½åä¸Šçœ‹æ˜¯ä¸“é—¨å¤„ç†æŸ¥è¯¢æ–¹æ³•çš„æ‹¦æˆªå™¨.æˆ‘å°è¯•åœ¨è¿™ä¸ªæ‹¦æˆªçš„<code>invoke</code>æ–¹æ³•è¿›è¡Œæ–­ç‚¹,æœç„¶æ‰§è¡Œ<code>findByTitle</code>æ—¶,ç¨‹åºæ‰§è¡Œåˆ°äº†è¿™é‡Œ.</p>
<figure data-type="image" tabindex="13"><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwfk4wcipfj31kw0fitcv.jpg" alt="image-20181021085124017"></figure>
<p>ç„¶ååœ¨æ‹¦æˆªå™¨æ–¹æ³•ä¸­åˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦ä¸ºæŸ¥è¯¢æ–¹æ³•,å¦‚æœæ˜¯å°±ä¼šæºå¸¦å‚æ•°è°ƒç”¨ <code>PartTreeMongoQuery</code>å¯¹è±¡ç»§æ‰¿è€Œæ¥çš„<code>AbstractMongoQuery#execute</code>æ–¹æ³•.</p>
<pre><code class="language-java">// AbstractMongoQuery
public Object execute(Object[] parameters) {
    MongoParameterAccessor accessor = new MongoParametersParameterAccessor(method, parameters);
    // æ„å»ºæŸ¥è¯¢å¯¹è±¡ Query: { &quot;title&quot; : &quot;sayHi&quot;}, Fields: null, Sort: null
    Query query = createQuery(new ConvertingParameterAccessor(operations.getConverter(), accessor));

    applyQueryMetaAttributesWhenPresent(query);
    ResultProcessor processor = method.getResultProcessor().withDynamicProjection(accessor);
    String collection = method.getEntityInformation().getCollectionName();
    // æ„å»ºæŸ¥è¯¢æ‰§è¡Œå¯¹è±¡
    MongoQueryExecution execution = getExecution(query, accessor,new ResultProcessingConverter(processor, operations, instantiators));
    
    return execution.execute(query, processor.getReturnedType().getDomainType(), collection);
}
</code></pre>
<p>è€Œ <code>MongoQueryExecution#execute</code>æ–¹æ³•é‡Œç»è¿‡å±‚å±‚åœ°è°ƒç”¨å®é™…æ‰§è¡Œè€Œä»¥ä¸‹ä»£ç :</p>
<pre><code class="language-java">// AbstractMongoQuery#execute =&gt;
	// MongoQueryExecution.ResultProcessingExecution#execute =&gt;
		// MongoQueryExecution.SingleEntityExecution#execute
@Override
public Object execute(Query query, Class&lt;?&gt; type, String collection) {
	return operations.findOne(query, type, collection);
}
</code></pre>
<p>è¿™é‡Œçš„ <code>operations</code> å°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ <code>MongoDBTemplate</code> å®ä¾‹.æ‰€ä»¥å½“æ‰§è¡Œ è‡ªå®šä¹‰æ–¹æ³•<code>findByTitile</code>æŸ¥è¯¢æ—¶åº•å±‚è°ƒç”¨çš„è¿˜æ˜¯<code>MongoDBTemplate#findOne</code>.</p>
<p>è€Œè¿™é‡Œä¹Ÿæœ‰ä¸ªç–‘é—®:æ„å»º<code>Query</code> å¯¹è±¡æ—¶èƒ½è·å–åˆ°å‚æ•°å€¼ä¸º<code>sayHi</code>,å¦‚ä½•æ˜¯è·å–å¯¹åº”æŸ¥è¯¢å­—æ®µä¸º<code>title</code>çš„å‘¢?</p>
<p>åœ¨æ–¹æ³•<code>createQuery</code>æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•,çœŸæ­£æ‰§è¡Œåœ¨``PartTreeMongoQuery`ç±»ä¸Š.</p>
<pre><code class="language-java">@Override
protected Query createQuery(ConvertingParameterAccessor accessor) {
	MongoQueryCreator creator = new MongoQueryCreator(tree, accessor, context, isGeoNearQuery);
	Query query = creator.createQuery();
	//...
	return query
}
</code></pre>
<p>è¿™é‡Œåœ¨æ„å»º<code>MongoQueryCreator</code>æ—¶æœ‰ä¸ª <code>tree</code> å±æ€§,è¿™ä¸ªå¯¹è±¡å°±æ˜¯æ„å»ºæ¡ä»¶æŸ¥è¯¢çš„å…³ç³».</p>
<figure data-type="image" tabindex="14"><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fwfl69kzpuj31a205qdgn.jpg" alt="image-20181021092719052"></figure>
<p>è€Œ <code>tree</code> å¯¹è±¡çš„åˆå§‹åŒ–åœ¨<code>PartTreeMongoQuery</code>è¿™ä¸ªç±»çš„æ„é€ å™¨ä¸­å®Œæˆçš„, æ ¹æ®æ–¹æ³•å, <code>PartTree</code>åˆæ˜¯å¦‚ä½•æ„é€ å‡ºæ¥çš„å‘¢.</p>
<pre><code class="language-java">//PartTree.java
public PartTree(String source, Class&lt;?&gt; domainClass) {

    Assert.notNull(source, &quot;Source must not be null&quot;);
    Assert.notNull(domainClass, &quot;Domain class must not be null&quot;);

    Matcher matcher = PREFIX_TEMPLATE.matcher(source);
    if (!matcher.find()) {
        this.subject = new Subject(null);
        this.predicate = new Predicate(source, domainClass);
    } else {
        this.subject = new Subject(matcher.group(0));
        // æ„é€ æŸ¥è¯¢å­—æ®µçš„å…³é”®
        this.predicate = new Predicate(source.substring(matcher.group().length()), domainClass);
    }
}
</code></pre>
<p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ° , ç”¨æ­£åˆ™æ–¹å¼åŒ¹é…æ–¹æ³•å,å…¶ä¸­ <code>PREFIX_TEMPLATE</code>è¡¨ç¤ºç€ <code>^(find|read|get|query|stream|count|exists|delete|remove)((\p{Lu}.*?))??By</code>, å¦‚æœåŒ¹é…åˆ°äº†å°±å°† By åé¢ç´§è·Ÿçš„å•è¯æå–å‡ºæ¥,å†…éƒ¨å†æ ¹æ®è¯¥åç§°å»åŒ¹é…å¯¹åº”ç±»çš„å±æ€§,æ‰¾åˆ°æ„å»ºå®Œæˆåå°±ä¼šæ”¾åœ¨ä¸€ä¸ª <code>ArrayList</code> é›†åˆé‡Œå­˜æ”¾,ç­‰å¾…åç»­æŸ¥è¯¢çš„æ—¶å€™ä½¿ç”¨.</p>
<p>æ‰€ä»¥ä¹Ÿå¯ä»¥çœ‹å‡º æˆ‘ä»¬è‡ªå®šä¹‰çš„æ–¹æ³• <code>findByTitle</code>ç¬¦åˆæ¡†æ¶é»˜è®¤çš„æ­£åˆ™è¦æ±‚,æ‰€ä»¥èƒ½è‡ªåŠ¨æå–åˆ°<code>Post</code> çš„ <code>title</code> å­—æ®µä½œä¸ºæŸ¥è¯¢å­—æ®µ. é™¤æ­¤ä¹‹å¤–,ä½¿ç”¨ç±»ä¼¼<code>queryBy</code>,<code>getBy</code>ç­‰ç­‰ä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·æ•ˆæœ, è¿™é‡Œä½“ç°çš„å°±æ˜¯ <code>Spring Framework</code> çº¦å®šç”±äºé…ç½®çš„æ€æƒ³, å¦‚æœæˆ‘ä»¬éšæ„å®šä¹‰æ–¹æ³•å,é‚£æ¡†æ¶å°±æ— æ³•ç›´æ¥è¯†åˆ«å‡ºæŸ¥è¯¢å­—æ®µäº†.</p>
<p>å¥½äº†åˆ°è¿™é‡Œ, æˆ‘ä»¬å†æ¬¡æ€»ç»“ä¸€ä¸‹æºç åˆ†ææˆæœ:</p>
<ul>
<li>å®šä¹‰<code>postRepository</code>å®ç°<code>MongoRepository</code>æ¥å£,æ“ä½œMongoDB æ•°æ®çš„åº•å±‚ä½¿ç”¨çš„ MongoDBTemplate, è€Œå®é™…ä½¿ç”¨æ—¶é€šè¿‡JDK åŠ¨æ€ä»£ç†å’Œ <code>AOP</code> æ‹¦æˆªå™¨æ–¹å¼å±‚å±‚è°ƒç”¨.</li>
<li>åœ¨<code>postRepository</code>ä¸­è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•æ˜¯è¦ç¬¦åˆ<code>spring-boot-data-mongodb</code>æ¡†æ¶çš„æ–¹æ³•å‘½åè§„åˆ™,æ‰èƒ½è¾¾åˆ°å®Œå…¨è‡ªåŠ¨å¤„ç†çš„æ•ˆæœ.</li>
</ul>
<h2 id="ç»“è¯­">ç»“è¯­</h2>
<p>åˆ°è¿™é‡Œ,æˆ‘ä»¬çš„ <code>Spring Boot</code> ä¸ <code>MongoDB</code> çš„å®æˆ˜åˆ†æå°±ç»“æŸäº†,ç»†çœ‹å†…éƒ¨æºç ,è™½ç„¶ç»“æ„å±‚æ¬¡æ¸…æ™°,ä½†ç”±äºæ¨¡å—é—´å¤æ‚è°ƒç”¨å…³ç³»,ä¹Ÿå¾€å¾€å®¹æ˜“è¿·å¤±äºæºç ä¸­,è¿™æ—¶å€™è€å¿ƒå’Œæ˜ç¡®çš„ç›®æ ‡å°±è‡³å…³é‡è¦.è¿™ç®—ä¹Ÿæ˜¯æœ¬æ¬¡æºç åˆ†æçš„æ”¶è·å§,å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½æœ‰æ›´å¤šæ”¶è·,æˆ‘ä»¬ä¸‹ç¯‡å†è§å§.ğŸ˜ğŸ˜ğŸ˜</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>http://blog.didispace.com/springbootmongodb/</li>
</ul>

          
          <p class="next-post">ä¸‹ä¸€ç¯‡ï¼š
            <a href="https://wrcj12138aaa.github.io//post/20181019-Java ä¿®ç‚¼ä¹‹é“-æ„å»ºå·¥å…·Maven">
              <span class="post-title">
                Java ä¿®ç‚¼ä¹‹é“:Maven&rarr;
              </span>
            </a>
          </p>
        
        <div class="comment">
          
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script>
  var gitalk = new Gitalk({
    clientID: '2ba76d6fe50ad2b384eb',
    clientSecret: '90db763ed48942571725d6aef11229900c8bb656',
    repo: 'wrcj12138aaa.github.io',
    owner: 'wrcj12138aaa',
    admin: ['wrcj12138aaa'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })
  gitalk.render('gitalk-container')
</script>

          
          
        
        </div>
      </div>
    </div>
  </article>
 <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li class="list-inline-item">
              <a href="https://wrcj12138aaa.github.io//atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li>
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>é—»äººçš„æŠ€æœ¯åšå®¢</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://wrcj12138aaa.github.io//media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://wrcj12138aaa.github.io//media/scripts/clean-blog.min.js"></script> -->
  <script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>â–²</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  </body>
</html>

